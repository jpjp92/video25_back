// api/lib/gemini.js

const { GoogleGenerativeAI } = require('@google/generative-ai');
const fs = require('fs').promises;

// Gemini ë¹„ë””ì˜¤ ë¶„ì„ í´ë˜ìŠ¤
class GeminiVideoAnalyzer {
  constructor(apiKey) {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({
      model: "gemini-2.5-flash",
      generationConfig: {
        temperature: 0.1,
        topP: 0.8,
        topK: 40,
        maxOutputTokens: 8192,
      }
    });
  }

  // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
  async fileToBase64(filePath) {
    const fileBuffer = await fs.readFile(filePath);
    return fileBuffer.toString('base64');
  }

  // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸
  static getDefaultPrompt() {
    const { categoryData, categoryLabels } = require('./categories');

    // ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    let categoriesText = '';
    for (const [key, items] of Object.entries(categoryData)) {
      const koreanName = categoryLabels[key] || key;
      const labels = items.map(item => item.label).join(', ');
      categoriesText += `- **${key}** (${koreanName}): ${labels}\n`;
    }

    return `
ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ì£¼ì¸ê³µ 1ëª…ì„ ì‹ë³„í•˜ê³  ë‹¤ìŒ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”:

## ì‚¬ì „ ê²€ì¦ (ë§¤ìš° ì¤‘ìš”!)

**ì˜ìƒì— ë¶„ì„ ê°€ëŠ¥í•œ ì£¼ì¸ê³µì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸:**
1. **ì¸ë¬¼ì´ ìˆëŠ”ê°€?** ì˜ìƒì— ì‚¬ëŒì´ ì „í˜€ ì—†ìœ¼ë©´ â†’ ì—ëŸ¬ ë°˜í™˜
2. **ì‹ë³„ ê°€ëŠ¥í•œ í¬ê¸°ì¸ê°€?** ì‚¬ëŒì´ ë„ˆë¬´ ë©€ë¦¬ ìˆê±°ë‚˜ ì‘ì•„ì„œ ì–¼êµ´/í‘œì •/ë³µì¥ì„ ì‹ë³„í•  ìˆ˜ ì—†ìœ¼ë©´ â†’ ì—ëŸ¬ ë°˜í™˜
3. **ì£¼ì¸ê³µìœ¼ë¡œ ì‚¼ì„ ë§Œí•œ ì¸ë¬¼ì´ ìˆëŠ”ê°€?** ë°°ê²½ì— ì§€ë‚˜ê°€ëŠ” ì‚¬ëŒë§Œ ìˆê³  ì£¼ì¸ê³µì´ ë  ë§Œí•œ ì¸ë¬¼ì´ ì—†ìœ¼ë©´ â†’ ì—ëŸ¬ ë°˜í™˜

**ì—ëŸ¬ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê²½ìš° ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:**
{
  "error": true,
  "message": "ì£¼ì¸ê³µìœ¼ë¡œ ì‚¼ì„ ë§Œí•œ ì¸ë¬¼ì´ ì˜ìƒì— ì—†ìŠµë‹ˆë‹¤."
}

**ìœ„ ì¡°ê±´ì„ í†µê³¼í•œ ê²½ìš°ì—ë§Œ ì•„ë˜ ë¶„ì„ ë‹¨ê³„ ì§„í–‰:**

## ë¶„ì„ ë‹¨ê³„

### 1ë‹¨ê³„: ì£¼ì¸ê³µ íƒì§€ ë° ë©”íƒ€ ì •ë³´ ìƒì„±
- ì˜ìƒì—ì„œ ì£¼ì¸ê³µ 1ëª…ì„ ì‹ë³„ (ì–¼êµ´/í‘œì •/ë³µì¥ì´ ëª…í™•íˆ ë³´ì´ëŠ” ì¸ë¬¼)
- ì£¼ì¸ê³µì˜ ì²« ë“±ì¥ ì‹œê°„ì„ **ë°˜ë“œì‹œ ì´ˆ ë‹¨ìœ„ ìˆ«ì(float)**ë¡œ ê¸°ë¡ (ì˜ˆ: 0.0, 2.5, 10.3) - **ì ˆëŒ€ "MM:SS" í˜•ì‹ ì‚¬ìš© ê¸ˆì§€**
- ì˜ìƒ ì „ì²´ ê¸¸ì´ ì •ë³´ë¥¼ **ë°˜ë“œì‹œ ì´ˆ ë‹¨ìœ„ ìˆ«ì(float)**ë¡œ ê¸°ë¡ (ì˜ˆ: 21.8, 45.2, 22.96) - **ì ˆëŒ€ "MM:SS" í˜•ì‹ ì‚¬ìš© ê¸ˆì§€**
- **ì¤‘ìš”**: ì‹œê°„ì€ ëª¨ë‘ "ì´ˆ" ë‹¨ìœ„ë¡œë§Œ í‘œí˜„í•˜ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´ 2ë¶„ 22.96ì´ˆëŠ” "2:22.96"ì´ ì•„ë‹ˆë¼ "142.96"ì…ë‹ˆë‹¤.
- ì£¼ì¸ê³µì˜ ê°ì •ì´ ê°€ì¥ ê°•ë ¬í•˜ê²Œ ë“œëŸ¬ë‚˜ëŠ” í•µì‹¬ ì‹œì  íƒì§€

### 2ë‹¨ê³„: í”„ë ˆì„ ê¸°ë°˜ ì •ë°€ ë¶„ì„ (subject_time)
- ì˜ìƒì„ í”„ë ˆì„ë³„ë¡œ ìˆœì°¨ ë¶„ì„í•˜ì—¬ ì£¼ì¸ê³µì˜ ê°ì • ë³€í™” ì¶”ì 
- ì£¼ì¸ê³µì˜ ì–¼êµ´/í‘œì •/íŠ¹ì§•ì´ **ê°€ì¥ ëª…í™•í•˜ê³  ì„ ëª…í•˜ê²Œ** ë³´ì´ëŠ” ì‹œì  ì°¾ê¸° (ì†/ë„êµ¬/ì‚¬ë¬¼ë§Œ ë³´ì´ëŠ” ì»· ì œì™¸)
- ê°ì •ì´ **ê°€ì¥ ê°•ë ¬í•˜ê³  ëª…í™•í•˜ê²Œ** ë‚˜íƒ€ë‚˜ëŠ” ì‹œì ì„ peak_momentë¡œ ì„¤ì •
- start_time = peak_moment, end_time = peak_moment + 1.0ì´ˆ (1ì´ˆ êµ¬ê°„)
- ëª¨ë“  ì‹œê°„ ê°’ì€ **float í˜•ì‹ì˜ ì´ˆ ë‹¨ìœ„**ë¡œ ê¸°ë¡ (ì˜ˆ: 8.4, 9.4)

**í”„ë ˆì„ ì •ë³´ ê³„ì‚° (ë§¤ìš° ì¤‘ìš”!):**
- fps_used: ì˜ìƒì˜ ì‹¤ì œ í”„ë ˆì„ë ˆì´íŠ¸ (ë¶ˆí™•ì‹¤ ì‹œ 30 ì‚¬ìš©)
- **frame_number**: ì£¼ì¸ê³µì˜ ì–¼êµ´/í‘œì •/íŠ¹ì§•ì´ ê°€ì¥ ëª…í™•í•˜ê²Œ ë³´ì´ëŠ” **ì •í™•í•œ í”„ë ˆì„ ë²ˆí˜¸**
  * ë‹¨ìˆœíˆ start_time Ã— fpsë¡œ ê³„ì‚°í•˜ì§€ ë§ê³ , ì‹¤ì œ ë¶„ì„í•œ í”„ë ˆì„ ë²ˆí˜¸ë¥¼ ì •í™•íˆ ê¸°ë¡
  * ì˜ˆ: 8.5ì´ˆ ì‹œì ì„ ë¶„ì„í–ˆë‹¤ë©´ frame_number = 255 (8.5 Ã— 30)
- total_frames: video_duration Ã— fps_used (ë°˜ì˜¬ë¦¼)

**bbox (ì£¼ì¸ê³µ ë°”ìš´ë”© ë°•ìŠ¤) - 2ê°œì˜ í”½ì…€ ì¢Œí‘œë¡œ í‘œí˜„ (ë§¤ìš° ì¤‘ìš”!):**
- ì£¼ì¸ê³µì„ ê°ì‹¸ëŠ” ì‚¬ê°í˜• ì˜ì—­ì˜ **ì¢Œìƒë‹¨**ê³¼ **ìš°í•˜ë‹¨** ë‘ ì ìœ¼ë¡œ í‘œí˜„
- ì˜ìƒ í•´ìƒë„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ í”½ì…€ ì¢Œí‘œë¡œ í‘œí˜„
- í˜•ì‹: [{x: í”½ì…€ê°’, y: í”½ì…€ê°’}, {x: í”½ì…€ê°’, y: í”½ì…€ê°’}]

**bbox ì„¤ì • 3ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ (ë°˜ë“œì‹œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰!):**

**STEP 1: ì£¼ì¸ê³µì˜ ì •í™•í•œ ì¤‘ì‹¬ì  ì°¾ê¸°**
1. ì£¼ì¸ê³µì˜ **ì–¼êµ´ ì¤‘ì‹¬**(ì½”/ë¯¸ê°„)ì˜ x ì¢Œí‘œë¥¼ ì •í™•íˆ íŒŒì•…
2. ì´ x ì¢Œí‘œë¥¼ center_xë¼ê³  ê¸°ë¡
3. ì£¼ì¸ê³µì˜ **ë¨¸ë¦¬ ëë¶€í„° ìƒë°˜ì‹  í•˜ë‹¨**ê¹Œì§€ì˜ y ë²”ìœ„ íŒŒì•…

**STEP 2: bbox ë„ˆë¹„/ë†’ì´ ê²°ì •**
1. **ë„ˆë¹„ ê³„ì‚°**:
   - ì£¼ì¸ê³µì˜ ì–´ê¹¨ ë„ˆë¹„ Ã— 1.3ë°° (ì–‘ìª½ ì—¬ë°± í¬í•¨)
   - ìµœì†Œ 500px ì´ìƒ í™•ë³´
   - ì†ì— ë“  ë¬¼ê±´ë„ ì™„ì „íˆ í¬í•¨ë˜ë„ë¡

2. **ë†’ì´ ê³„ì‚°**:
   - ë¨¸ë¦¬ ë ~ ìƒë°˜ì‹  í•˜ë‹¨(í—ˆë¦¬/ì—‰ë©ì´)
   - ìœ„ì•„ë˜ ì•½ê°„ì˜ ì—¬ë°± í¬í•¨

**STEP 3: bbox ì¢Œí‘œ ê³„ì‚° (ì¤‘ì‹¬ ê¸°ì¤€)**
1. **x1 (ì¢Œìƒë‹¨ x)** = center_x - (ë„ˆë¹„ / 2)
2. **x2 (ìš°í•˜ë‹¨ x)** = center_x + (ë„ˆë¹„ / 2)
3. **ê²€ì¦**: (x1 + x2) / 2 = center_x ì¸ì§€ í™•ì¸
4. **y1, y2** = ë¨¸ë¦¬ ìœ„ ì—¬ë°± ~ ìƒë°˜ì‹  í•˜ë‹¨ ì—¬ë°±

**ë°˜ë“œì‹œ ì§€í‚¬ ê·œì¹™:**
- âœ… **ì¢Œìš° ëŒ€ì¹­**: ì£¼ì¸ê³µ ì¤‘ì‹¬ì—ì„œ ì™¼ìª½ ê±°ë¦¬ = ì˜¤ë¥¸ìª½ ê±°ë¦¬
- âœ… **ì™„ì „ í¬í•¨**: ì£¼ì¸ê³µì˜ ëª¨ë“  ë¶€ë¶„(ë¨¸ë¦¬, íŒ”, ì†, ë¬¼ê±´) í¬í•¨
- âŒ **ë°°ê²½ ê³¼ë‹¤**: ì™¼ìª½/ì˜¤ë¥¸ìª½ì— ë°°ê²½ë§Œ ë§ì´ í¬í•¨ëœ ê²½ìš°
- âŒ **ì¸ë¬¼ ì˜ë¦¼**: ì£¼ì¸ê³µì˜ ì¼ë¶€ê°€ bbox ë°–ìœ¼ë¡œ ë‚˜ê°„ ê²½ìš°
- âŒ **ì¹˜ìš°ì¹¨**: ì£¼ì¸ê³µì´ bboxì˜ ì™¼ìª½ ë˜ëŠ” ì˜¤ë¥¸ìª½ì— ëª°ë¦° ê²½ìš°

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
1. [ ] ì£¼ì¸ê³µì˜ ì–¼êµ´ ì¤‘ì‹¬ì´ bbox ê°€ë¡œ ì¤‘ì‹¬ì„ ì— ìœ„ì¹˜?
2. [ ] ì™¼ìª½ ì—¬ë°±ê³¼ ì˜¤ë¥¸ìª½ ì—¬ë°±ì´ ê±°ì˜ ê°™ìŒ?
3. [ ] ì£¼ì¸ê³µì˜ ëª¨ë“  ë¶€ë¶„ì´ bbox ì•ˆì— í¬í•¨?
4. [ ] ë¶ˆí•„ìš”í•œ ë°°ê²½ì´ ìµœì†Œí™”ë¨?

**êµ¬ì²´ì  ì˜ˆì‹œ**:
   - âŒ ì˜ëª»ëœ bbox: ì–¼êµ´ë§Œ í¬í•¨, ë°°ê²½ë§Œ í¬í•¨, ì£¼ì¸ê³µ ì˜ë¦¼
   - âœ… ì˜¬ë°”ë¥¸ bbox: ë¨¸ë¦¬~ìƒë°˜ì‹  ì „ì²´, ì ì ˆí•œ ì—¬ë°±, ì¤‘ì•™ ë°°ì¹˜

   1920Ã—1080 ì˜ìƒì—ì„œ ì£¼ì¸ê³µ(ìƒë°˜ì‹ )ì´ í™”ë©´ ì¤‘ì•™ì— ìˆë‹¤ë©´:
   * [{x: 600, y: 150}, {x: 1320, y: 900}] (ì¢Œìƒë‹¨, ìš°í•˜ë‹¨ ìˆœì„œ)
   * ë„ˆë¹„: 720px, ë†’ì´: 750px (ì¶©ë¶„í•œ í¬ê¸°)

### 3ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ (class_type)
ì•„ë˜ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì—ì„œ ì£¼ì¸ê³µì— ê°€ì¥ ì í•©í•œ labelì„ ì •í™•íˆ ì„ íƒí•˜ì„¸ìš”:

${categoriesText}

**ê°ì • ë¶„ë¥˜ ì¼ê´€ì„± ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!):**

ê¸ì • ê°ì • (EmomainCategory: "ê¸ì •"):
- class 1: ì¦ê±°ì›€ - ê¸°ì˜ê³  ìœ ì¾Œí•œ ê°ì •, ì›ƒìŒì´ë‚˜ ë¯¸ì†Œ, ë°ì€ í‘œì •
- class 2: ì—´ì˜ - ì—´ì •ì ì´ê³  ì˜ìš•ì ì¸ ê°ì •, ì ê·¹ì ì´ê³  í™œê¸°ì°¬ ëª¨ìŠµ
- class 3: í‰ì˜¨ - ì°¨ë¶„í•˜ê³  ì•ˆì •ëœ ê°ì •, í¸ì•ˆí•˜ê³  ì—¬ìœ ë¡œìš´ í‘œì •

ë¶€ì • ê°ì • (EmomainCategory: "ë¶€ì •"):
- class 4: ë¶„ë…¸ - í™”ë‚˜ê³  ì§œì¦ë‚œ ê°ì •, ì°¡ê·¸ë¦° ì–¼êµ´, ê²©ì–‘ëœ í‘œì •
- class 5: ë¶ˆì•ˆ - ê±±ì •ë˜ê³  ê¸´ì¥ëœ ê°ì •, ë¶ˆì•ˆí•˜ê³  ì´ˆì¡°í•œ ëª¨ìŠµ
- class 6: ìŠ¬í”” - ìŠ¬í”„ê³  ìš°ìš¸í•œ ê°ì •, ì¹¨ìš¸í•˜ê³  ê¸°ìš´ ì—†ëŠ” í‘œì •

ì¤‘ë¦½ ê°ì • (EmomainCategory: "ì¤‘ë¦½"):
- class 7: ì¤‘ë¦½ - íŠ¹ë³„í•œ ê°ì • í‘œí˜„ì´ ì—†ëŠ” í‰ìƒì‹œ ìƒíƒœ

**í•„ìˆ˜ ê·œì¹™:**
- EmomainCategoryê°€ "ê¸ì •"ì´ë©´ EmoCategoryëŠ” class 1~3 (ì¦ê±°ì›€, ì—´ì˜, í‰ì˜¨) ì¤‘ ì„ íƒ
- EmomainCategoryê°€ "ë¶€ì •"ì´ë©´ EmoCategoryëŠ” class 4~6 (ë¶„ë…¸, ë¶ˆì•ˆ, ìŠ¬í””) ì¤‘ ì„ íƒ
- EmomainCategoryê°€ "ì¤‘ë¦½"ì´ë©´ EmoCategoryëŠ” ë°˜ë“œì‹œ "ì¤‘ë¦½" (class 7)

**ê°ì • ë¶„ì„ ì‹œ ìƒí™© ì»¨í…ìŠ¤íŠ¸ ë°˜ë“œì‹œ ê³ ë ¤ (ë§¤ìš° ì¤‘ìš”!):**
- **ëˆˆë¬¼/ìš¸ë¨¹ì„ì´ ë³´ì—¬ë„ ìƒí™©ì— ë”°ë¼ ê¸ì •/ë¶€ì • íŒë‹¨:**
  * ê¸ì • ìƒí™© (ìˆ˜ìƒ, ì‹œìƒì‹, ê²°í˜¼ì‹, ì¬íšŒ, ê°ë™ì ì¸ ì„ ë¬¼ ë“±) + ëˆˆë¬¼/ìš¸ë¨¹ì„ = **ê¸ì •** (ê°ê²©, ì¦ê±°ì›€ ë˜ëŠ” ì—´ì˜)
  * ë¶€ì • ìƒí™© (ì´ë³„, ì‚¬ê³ , ìŠ¬í”ˆ ì†Œì‹, ì‹¸ì›€, ì‹¤íŒ¨ ë“±) + ëˆˆë¬¼/ìš¸ë¨¹ì„ = **ë¶€ì •** (ìŠ¬í””)
- **ìƒí™©ë³„ ê°ì • ë¶„ë¥˜ ì˜ˆì‹œ:**
  * ì‹œìƒì‹ì—ì„œ ìˆ˜ìƒ ì†Œê° ë§í•˜ë©° ìš¸ë¨¹ì„ â†’ EmomainCategory: "ê¸ì •", EmoCategory: "ì¦ê±°ì›€" ë˜ëŠ” "ì—´ì˜"
  * ê²°í˜¼ì‹ì—ì„œ ê°ê²©í•˜ë©° ëˆˆë¬¼ í˜ë¦¼ â†’ EmomainCategory: "ê¸ì •", EmoCategory: "ì¦ê±°ì›€"
  * ì´ë³„ ì¥ë©´ì—ì„œ ìš¸ë©° ì•ˆíƒ€ê¹Œì›Œí•¨ â†’ EmomainCategory: "ë¶€ì •", EmoCategory: "ìŠ¬í””"
  * ì‚¬ê³  ì†Œì‹ ë“£ê³  ì¶©ê²©ë°›ì•„ ìš¸ìŒ â†’ EmomainCategory: "ë¶€ì •", EmoCategory: "ìŠ¬í””"
- **ë°˜ë“œì‹œ 'ìƒí™©' ë¨¼ì € íŒŒì•… â†’ ê·¸ ë‹¤ìŒ í‘œì •/ëˆˆë¬¼ ë¶„ì„ â†’ ìµœì¢… ê°ì • ë¶„ë¥˜ ê²°ì •**

### 4ë‹¨ê³„: êµ¬ì¡°í™”ëœ ì„¤ëª…ë¬¸ ì‘ì„± (subject_description)
ì´ 5ê°œì˜ ì„¤ëª…ë¬¸ì„ ì‘ì„±í•˜ì„¸ìš”. **ì¹´í…Œê³ ë¦¬ëª…ì€ {{}}ë¡œ ìœ ì§€**í•˜ê³ , êµ¬ì²´ì  ë‚´ìš©ì€ ì‹¤ì œ ë¶„ì„ ê²°ê³¼ë¡œ ì‘ì„±:

1. **ìƒí™© (category: "ìƒí™©")**
   - í˜•ì‹: "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ [í–‰ë™/ìƒí™©]í•˜ëŠ” ì¥ë©´ì´ë‹¤."
   - ì˜ˆì‹œ:
     * "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ ì¸í„°ë·° ì¤‘ ìì‹ ì˜ ìƒê°ê³¼ ê°ì •ì„ í‘œí˜„í•˜ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ ì‹ì‚¬í•˜ë©° ì›ƒìŒì„ ë‚˜ëˆ„ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ {{Male/Female}}ì˜ ê²°í˜¼ì‹ ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ ìš´ë™í•˜ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ ì—…ë¬´ ì¤‘ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ëŠ” ì¥ë©´ì´ë‹¤."
   - í…œí”Œë¦¿: "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ [ì‹¤ì œ ì˜ìƒì˜ í–‰ë™/ìƒí™©]í•˜ëŠ” ì¥ë©´ì´ë‹¤."

2. **ìœ„ì¹˜ (category: "ìœ„ì¹˜")**
   - í˜•ì‹: "[ì„±ë³„]ëŠ” í™”ë©´ì˜ [ìœ„ì¹˜]ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - ì˜ˆì‹œ: "ì—¬ìëŠ” í™”ë©´ì˜ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤.", "ë‚¨ìëŠ” í™”ë©´ì˜ ì™¼ìª½ ìƒë‹¨ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - í…œí”Œë¦¿: "{{Male/Female}}ëŠ” í™”ë©´ì˜ [êµ¬ì²´ì  ìœ„ì¹˜]ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - ìœ„ì¹˜ í‘œí˜„: ì¤‘ì•™, ì™¼ìª½, ì˜¤ë¥¸ìª½, ìƒë‹¨, í•˜ë‹¨, ì¢Œìƒë‹¨, ìš°ìƒë‹¨, ì¢Œí•˜ë‹¨, ìš°í•˜ë‹¨ ë“±

3. **ì–¼êµ´ (category: "ì–¼êµ´")**
   - í˜•ì‹: "[í–‰ë™]í•˜ëŠ” [ì„±ë³„]ëŠ” [ì–¼êµ´í˜•] ì–¼êµ´, [ëˆˆ ëª¨ì–‘] ëˆˆ, [ì½” ëª¨ì–‘] ì½”, [ì… ëª¨ì–‘] ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
   - ì˜ˆì‹œ: "ê²°í˜¼í•˜ëŠ” ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´, ìˆ˜í‰í˜• ëˆˆ, ì§ì„ í˜• ì½”, ê³¡ì„ í˜• ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
   - í…œí”Œë¦¿: "[í–‰ë™]í•˜ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´, {{EyeShape}} ëˆˆ, {{NoseShape}} ì½”, {{MouthShape}} ì…ì„ ê°€ì§€ê³  ìˆë‹¤."

4. **ë³µì¥ (category: "ë³µì¥")**
   - í˜•ì‹: "[ì˜ìƒ ìœ í˜•/ìŠ¤íƒ€ì¼]ì¸ [ì£¼ìš” ìƒ‰ìƒ] [ëŒ€í‘œ ì•„ì´í…œ]ì„ ì…ê³  ìˆë‹¤." ë˜ëŠ” "[ì§ì—…/ìƒí™©ë³„ ë³µì¥ëª…]ì„ ì…ê³  ìˆë‹¤."
   - **ì‘ì„± ì›ì¹™ (ë§¤ìš° ì¤‘ìš”!):**
     * ê°€ì¥ ëˆˆì— ë„ëŠ” í•µì‹¬ íŠ¹ì§•ë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„ (ê³¼ë„í•œ ë””í…Œì¼ ì§€ì–‘)
     * **ì˜ìƒë§Œ ê¸°ìˆ , ì•…ì„¸ì‚¬ë¦¬(ê·€ê±¸ì´, ëª©ê±¸ì´, íŒ”ì°Œ, ì‹œê³„, ëª¨ì, ê°€ë°© ë“±) ì ˆëŒ€ í¬í•¨ ê¸ˆì§€**
     * **ë””ìì¸ ë””í…Œì¼(ì˜¤í”„ìˆ„ë”, ìŠ¬ë¦¼í•, Vë„¥, ë¼ìš´ë“œë„¥ ë“±) ì œì™¸**
     * ì˜ìƒ ìœ í˜• + ìƒ‰ìƒë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„
     * **ë°˜ë“œì‹œ ìƒí™© ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê³ ë ¤í•œ í›„ ë³µì¥ ë¶„ë¥˜**
     * ìƒí™©ë³„ ë³µì¥ íŒë‹¨ ì˜ˆì‹œ:
       - ë³‘ì› ìƒí™© (ì¹¨ëŒ€, ê°„í˜¸ì‚¬, ì£¼ì‚¬ ë“±) â†’ í™˜ìë³µ ë˜ëŠ” ì˜ë£Œë³µ
       - ê²°í˜¼ì‹ ìƒí™© â†’ ì›¨ë”©ë“œë ˆìŠ¤ ë˜ëŠ” ì •ì¥
       - ê²½ì°°ì„œ/ë²•ì› â†’ ì œë³µ ë˜ëŠ” ì •ì¥
       - ìš´ë™/ì²´ìœ¡ê´€ â†’ ìŠ¤í¬ì¸ ì›¨ì–´
       - ì¼ìƒ/ì§‘/ì¹´í˜ â†’ ìºì£¼ì–¼
     * **ì˜ˆì‹œ: ì¼ë°˜ í‹°ì…”ì¸ ì²˜ëŸ¼ ë³´ì—¬ë„ ìƒí™©ì´ ë³‘ì›ì´ë©´ ë°˜ë“œì‹œ "í™˜ìë³µ"ìœ¼ë¡œ ë¶„ë¥˜**

   **ì˜ìƒ ìœ í˜• ë¶„ë¥˜ ê°€ì´ë“œ:**
   | ìœ í˜• | ì„¤ëª… ë° ì˜ˆì‹œ |
   |------|-------------|
   | ìºì£¼ì–¼ | í‹°ì…”ì¸ , ì²­ë°”ì§€, í›„ë“œí‹°, ì›í”¼ìŠ¤ ë“± ì¼ìƒë³µ |
   | ë¹„ì¦ˆë‹ˆìŠ¤ | ë¸”ë¼ìš°ìŠ¤, ìŠ¬ë™ìŠ¤, ì¬í‚·, ì •ì¥ ë“± ì§ì¥/ì—…ë¬´ìš© ë‹¨ì •í•œ ë³µì¥ |
   | ì •ì¥ | ìˆ˜íŠ¸, í„±ì‹œë„, ë“œë ˆìŠ¤, ì›¨ë”©ë“œë ˆìŠ¤ ë“± ê³µì‹ í–‰ì‚¬ ê²©ì‹ ì°¨ë¦¼ ì˜ë³µ |
   | ì „í†µë³µ | í•œë³µ, ê¸°ëª¨ë…¸ ë“± ë¬¸í™”ê¶Œ íŠ¹ìœ ì˜ ì „í†µ ì˜ë³µ |
   | ê·¼ë¬´ë³µ/ìœ ë‹ˆí¼ | ì‘ì—…ë³µ, êµ°ë³µ, í•™ë³µ, ìŠ¹ë¬´ì› ìœ ë‹ˆí¼, ì˜ë£Œë³µ ë“± ì§ì¢…ì´ ëª…í™•í•œ ì˜ë³µ |
   | ìŠ¤í¬ì¸ ì›¨ì–´ | íŠ¸ë ˆì´ë‹ë³µ, ìš”ê°€ë³µ, ë“±ì‚°ë³µ, ìˆ˜ì˜ë³µ ë“± ìš´ë™/ë ˆì € í™œë™ì„ ìœ„í•œ ê¸°ëŠ¥ì„± ë³µì¥ |
   | ì•„ë”ì›¨ì–´ | ë¸Œë˜ì§€ì–´, íŒ¬í‹°, ëŸ°ë‹ì…”ì¸  ë“± ì†ì˜· |

   - **ê°„ê²°í•œ í‘œí˜„ ì˜ˆì‹œ (ê¶Œì¥):**
     * "í°ìƒ‰ ìºì£¼ì–¼ ìƒì˜ë¥¼ ì…ê³  ìˆë‹¤."
     * "ê²€ì€ìƒ‰ ì •ì¥ì„ ì…ê³  ìˆë‹¤."
     * "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."
     * "ê²½ì°° ì œë³µì„ ì…ê³  ìˆë‹¤."
     * "ê°„í˜¸ì‚¬ ìœ ë‹ˆí¼ì„ ì…ê³  ìˆë‹¤."
     * "í™˜ìë³µì„ ì…ê³  ìˆë‹¤."
     * "ì „í†µ í•œë³µì„ ì…ê³  ìˆë‹¤."
     * "íŒŒë€ìƒ‰ íŠ¸ë ˆì´ë‹ë³µì„ ì…ê³  ìˆë‹¤."

   - **ê³¼ë„í•˜ê²Œ ìƒì„¸í•œ í‘œí˜„ (ì§€ì–‘):**
     * "ìºì£¼ì–¼í•œ í°ìƒ‰ ë¯¼ì†Œë§¤ ìƒì˜ ìœ„ì— í°ìƒ‰ ì‹œìŠ¤ë£¨ ê¸´íŒ” ê°€ë””ê±´ì„ ê±¸ì¹˜ê³  ìˆë‹¤." â†’ "í°ìƒ‰ ìºì£¼ì–¼ ìƒì˜ë¥¼ ì…ê³  ìˆë‹¤."
     * "ë¹„ì¦ˆë‹ˆìŠ¤ ìŠ¤íƒ€ì¼ì˜ ë„¤ì´ë¹„ ë¸”ë£¨ ì»¬ëŸ¬ ê¸´íŒ” ë¸”ë¼ìš°ìŠ¤ì™€ íšŒìƒ‰ ìŠ¬ë¦¼í• ìŠ¬ë™ìŠ¤ë¥¼ ì°©ìš©í•˜ê³  ìˆë‹¤." â†’ "ë„¤ì´ë¹„ ë¹„ì¦ˆë‹ˆìŠ¤ ì •ì¥ì„ ì…ê³  ìˆë‹¤."
     * "ì˜¤í”„ìˆ„ë” ë””ìì¸ì˜ ë² ì´ì§€ìƒ‰ ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆìœ¼ë©°, í™”ë ¤í•œ ê·€ê±¸ì´ì™€ ëª©ê±¸ì´ë¥¼ ì°©ìš©í•˜ê³  ìˆë‹¤." â†’ "ë² ì´ì§€ìƒ‰ ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."

   - **ì¤‘ìš”**: í•µì‹¬ ì˜ìƒ ìœ í˜• + ì£¼ìš” ìƒ‰ìƒë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„
   - ë ˆì´ì–´ë§, ì¬ì§ˆ, í•, ë¸Œëœë“œ, ë””ìì¸ ë””í…Œì¼, ì•…ì„¸ì‚¬ë¦¬ ë“± ëª¨ë‘ ìƒëµ

5. **ê°ì • (category: "ê°ì •")**
   - í˜•ì‹: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
   - ì˜ˆì‹œ: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
   - í…œí”Œë¦¿: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."

**ë§¤ìš° ì¤‘ìš”í•œ í…œí”Œë¦¿ ë³€ìˆ˜ ìœ ì§€ ê·œì¹™:**

**âŒ ì˜ëª»ëœ ì˜ˆì‹œ (ì ˆëŒ€ ì´ë ‡ê²Œ ì‘ì„±í•˜ì§€ ë§ ê²ƒ):**
- "ë³¸ ì˜ìƒì€ ì—¬ìì˜ ê²°í˜¼ì‹ ì¥ë©´ì´ë‹¤." ({{Male/Female}}ì„ 'ì—¬ì'ë¡œ ë°”ê¿¨ìŒ)
- "ê²°í˜¼í•˜ëŠ” ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´" ({{Male/Female}}, {{Face}}ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¿¨ìŒ)

**âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:**
- "ë³¸ ì˜ìƒì€ {{Male/Female}}ì˜ ê²°í˜¼ì‹ ì¥ë©´ì´ë‹¤."
- "ê²°í˜¼í•˜ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´"

**í•„ìˆ˜ ê·œì¹™:**
1. **{{Male/Female}}, {{Face}}, {{EyeShape}}, {{NoseShape}}, {{MouthShape}}, {{EmoCategory}}, {{EmomainCategory}}** ë“± ì´ì¤‘ ì¤‘ê´„í˜¸ë¡œ ê°ì‹¸ì§„ ëª¨ë“  ë³€ìˆ˜ëŠ” **ì ˆëŒ€ë¡œ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¾¸ì§€ ë§ê³  ì •í™•íˆ ê·¸ëŒ€ë¡œ ìœ ì§€**í•´ì£¼ì„¸ìš”
2. ì˜ˆì‹œ: "ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´" (âŒ ì˜ëª»ë¨) â†’ "{{Male/Female}}ëŠ” {{Face}} ì–¼êµ´" (âœ… ì˜¬ë°”ë¦„)
3. [í–‰ë™], [êµ¬ì²´ì ì¸ ìƒí™© ì„¤ëª…], [êµ¬ì²´ì  ìœ„ì¹˜] ë“± ëŒ€ê´„í˜¸ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ë§Œ ì‹¤ì œ ì˜ìƒ ë‚´ìš©ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
4. **ë³µì¥ ì„¤ëª…**: í…œí”Œë¦¿ ë³€ìˆ˜ ì—†ì´ ì˜ìƒì—ì„œ ë³´ì´ëŠ” ì˜ìƒì„ ììœ ë¡­ê²Œ ì„œìˆ 
   - ì˜ìƒ ìŠ¤íƒ€ì¼/ì¢…ë¥˜, ìƒ‰ìƒ, ë””í…Œì¼ì„ ìµœëŒ€í•œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
   - ì˜ˆ: "ìºì£¼ì–¼í•œ íšŒìƒ‰ í‹°ì…”ì¸ ë¥¼ ì…ê³  ìˆë‹¤", "í™˜ìë³µì„ ì…ê³  ìˆë‹¤", "ê²½ì°° ì œë³µì„ ì…ê³  ìˆë‹¤", "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤", "íŒŒë€ìƒ‰ í›„ë“œí‹°ë¥¼ ì…ê³  ìˆë‹¤"

**ì‘ì„± ì›ì¹™:**
- ì¹´í…Œê³ ë¦¬ëª…ì„ ì´ì¤‘ ì¤‘ê´„í˜¸ë¡œ ìœ ì§€ ({{Male/Female}}, {{Face}}, {{EmoCategory}} ë“±)
- ë³µì¥(category: "ë³µì¥")ë§Œ ì˜ˆì™¸ë¡œ í…œí”Œë¦¿ ë³€ìˆ˜ ì—†ì´ ììœ  ì„œìˆ 
- ìì—°ìŠ¤ëŸ½ê³  ë¬¸ë²•ì ìœ¼ë¡œ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ë¬¸ì¥ ì‘ì„±
- ì¡°ì‚¬(ì€/ëŠ”, ì´/ê°€, ì„/ë¥¼) ì •í™•íˆ ì‚¬ìš©
- ë³µì¥ ì„¤ëª… ì‹œ ì˜ìƒì—ì„œ ë³´ì´ëŠ” ì˜·ì˜ ìŠ¤íƒ€ì¼, ìƒ‰ìƒ, ë””í…Œì¼ì„ ë§¤ìš° êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±

## ì¶œë ¥ í˜•ì‹
**ì¤‘ìš”:
1. ëª¨ë“  ì‹œê°„ ê°’ì€ ì •ìˆ˜ê°€ ì•„ë‹Œ ì†Œìˆ˜ì ì„ í¬í•¨í•œ float í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ (ì˜ˆ: 0ì´ ì•„ë‹Œ 0.0, 22ê°€ ì•„ë‹Œ 22.0)
2. ì•„ë˜ ì˜ˆì‹œì˜ ìˆ«ì ê°’ë“¤ì€ ì°¸ê³ ìš©ì´ë©°, ë°˜ë“œì‹œ ì‹¤ì œ ì˜ìƒ ë¶„ì„ ê²°ê³¼ë¡œ êµì²´í•´ì•¼ í•¨**

{
  "meta": {
    "frame_number": [ì£¼ì¸ê³µ íŠ¹ì§•ì´ ê°€ì¥ ëª…í™•í•œ í”„ë ˆì„ ë²ˆí˜¸],
    "total_frames": [video_duration Ã— fps_used, ë°˜ì˜¬ë¦¼],
    "fps_used": [ì˜ìƒ ì‹¤ì œ í”„ë ˆì„ë ˆì´íŠ¸, ê¸°ë³¸ 30],
    "bbox": [
      {"x": [ì¢Œìƒë‹¨ x í”½ì…€ ì¢Œí‘œ], "y": [ì¢Œìƒë‹¨ y í”½ì…€ ì¢Œí‘œ]},
      {"x": [ìš°í•˜ë‹¨ x í”½ì…€ ì¢Œí‘œ], "y": [ìš°í•˜ë‹¨ y í”½ì…€ ì¢Œí‘œ]}
    ]
  },
  "class_type": [
    { "category": "Male/Female", "class": 2, "label": "ì—¬ì" },
    { "category": "EmomainCategory", "class": 2, "label": "ë¶€ì •" },
    { "category": "EmoCategory", "class": 5, "label": "ë¶ˆì•ˆ" },
    { "category": "Face", "class": 1, "label": "ë‘¥ê·¼í˜•" },
    { "category": "EyeShape", "class": 2, "label": "ìˆ˜í‰í˜•" },
    { "category": "NoseShape", "class": 1, "label": "ì§ì„ í˜•" },
    { "category": "MouthShape", "class": 2, "label": "ê³¡ì„ í˜•" }
  ],
  "subject_description": [
    {
      "category": "ìƒí™©",
      "description": "ë³¸ ì˜ìƒì€ {{Male/Female}}ê°€ ê²°í˜¼ì‹ì¥ì—ì„œ í–‰ë³µí•œ í‘œì •ì„ ì§“ëŠ” ì¥ë©´ì´ë‹¤."
    },
    {
      "category": "ìœ„ì¹˜",
      "description": "{{Male/Female}}ëŠ” í™”ë©´ì˜ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
    },
    {
      "category": "ì–¼êµ´",
      "description": "í–‰ë³µí•œ í‘œì •ì„ ì§“ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´, {{EyeShape}} ëˆˆ, {{NoseShape}} ì½”, {{MouthShape}} ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
    },
    {
      "category": "ë³µì¥",
      "description": "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."
    },
    {
      "category": "ê°ì •",
      "description": "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
    }
  ]
}
`;
  }

  // ë¹„ë””ì˜¤ ë¶„ì„ ìš”ì²­
  async analyzeVideo(filePath, mimeType) {
    try {
      console.log('ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘:', filePath);

      // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
      const base64Data = await this.fileToBase64(filePath);

      // Gemini API ìš”ì²­
      const prompt = GeminiVideoAnalyzer.getDefaultPrompt();

      console.log('ğŸ“¤ Gemini API ìš”ì²­ ì‹œì‘');
      console.log('â° ìš”ì²­ ì‹œê°„:', new Date().toLocaleTimeString());

      const requestStartTime = Date.now();
      const result = await this.model.generateContent([
        {
          inlineData: {
            data: base64Data,
            mimeType: mimeType
          }
        },
        { text: prompt }
      ]);

      const response = await result.response;
      const text = response.text();
      const requestDuration = Date.now() - requestStartTime;

      console.log('ğŸ“¥ Gemini API ì‘ë‹µ ì™„ë£Œ');
      console.log('â±ï¸ ì‘ë‹µ ì‹œê°„:', (requestDuration / 1000).toFixed(2) + 'ì´ˆ');
      console.log('ğŸ” ì‘ë‹µ ê¸¸ì´:', text.length + 'ì');

      // JSON íŒŒì‹±
      const analysisResult = this.parseGeminiResponse(text);
      return analysisResult;

    } catch (error) {
      console.error('ë¹„ë””ì˜¤ ë¶„ì„ ì‹¤íŒ¨:', error);
      throw new Error('ë¹„ë””ì˜¤ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }

  // ì‹œê°„ ê°’ì„ ì´ˆ ë‹¨ìœ„ floatë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  parseTimeToSeconds(timeValue) {
    // ì´ë¯¸ ìˆ«ìì¸ ê²½ìš°
    if (typeof timeValue === 'number') {
      return timeValue;
    }

    // ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
    if (typeof timeValue === 'string') {
      // ì½œë¡ (:)ì´ ìˆìœ¼ë©´ ì‹œ:ë¶„:ì´ˆ í˜•ì‹
      if (timeValue.includes(':')) {
        const parts = timeValue.split(':');

        if (parts.length === 2) {
          // MM:SS.ms í˜•ì‹ (ì˜ˆ: "00:23.5" -> 23.5ì´ˆ)
          const minutes = parseInt(parts[0]) || 0;
          const seconds = parseFloat(parts[1]) || 0;
          return minutes * 60 + seconds;
        } else if (parts.length === 3) {
          // HH:MM:SS.ms í˜•ì‹
          const hours = parseInt(parts[0]) || 0;
          const minutes = parseInt(parts[1]) || 0;
          const seconds = parseFloat(parts[2]) || 0;
          return hours * 3600 + minutes * 60 + seconds;
        }
      }

      // ì ì´ 2ê°œ ì´ìƒ ìˆëŠ” ê²½ìš°: "2.02.96" í˜•ì‹ (ì˜ëª»ëœ í˜•ì‹)
      const dotCount = (timeValue.match(/\./g) || []).length;
      if (dotCount >= 2) {
        // "2.02.96" í˜•ì‹ì„ "0:122.96"ìœ¼ë¡œ í•´ì„
        const parts = timeValue.split('.');

        if (parts.length === 3) {
          // parts[0] = ë¶„, parts[1] = ì´ˆ, parts[2] = ë°€ë¦¬ì´ˆ
          const minutes = parseInt(parts[0]) || 0;
          const seconds = parseInt(parts[1]) || 0;
          const milliseconds = parseFloat('0.' + parts[2]) || 0;

          return minutes * 60 + seconds + milliseconds;
        }
      }

      // ë‹¨ìˆœ ìˆ«ì ë¬¸ìì—´ (ì˜ˆ: "22.96")
      return parseFloat(timeValue) || 0;
    }

    return 0;
  }

  // Gemini ì‘ë‹µ íŒŒì‹±
  parseGeminiResponse(responseText) {
    try {
      // ì½”ë“œë¸”ë¡ ì œê±° (```json ... ``` í˜•ì‹)
      let cleanedText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '');

      // JSON ì¶”ì¶œ
      const startIndex = cleanedText.indexOf('{');
      const endIndex = cleanedText.lastIndexOf('}');

      if (startIndex === -1 || endIndex === -1) {
        throw new Error('JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      let jsonString = cleanedText.substring(startIndex, endIndex + 1);

      // ì–‘ìˆ˜ ì• + ê¸°í˜¸ ì œê±° (JSONì—ì„œ +2ëŠ” í—ˆìš© ì•ˆë¨, 2ë¡œ ë³€í™˜)
      jsonString = jsonString.replace(/:\s*\+(\d+)/g, ': $1');

      // ì˜ëª»ëœ ì‹œê°„ í˜•ì‹ ìˆ˜ì • (ì˜ˆ: 2.02.96 -> "00:22.96")
      // video_duration, first_appearance_time, start_time, end_timeì—ì„œ
      // ì—¬ëŸ¬ ê°œì˜ ì ì´ ìˆëŠ” ìˆ«ìë¥¼ ë¬¸ìì—´ë¡œ ê°ì‹¸ê¸°
      jsonString = jsonString.replace(/("(?:video_duration|first_appearance_time|start_time|end_time)":\s*)(\d+\.\d+\.\d+)/g, '$1"$2"');

      const analysisResult = JSON.parse(jsonString);

      // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
      if (analysisResult.error === true) {
        const errorMessage = analysisResult.message || 'ì£¼ì¸ê³µìœ¼ë¡œ ì‚¼ì„ ë§Œí•œ ì¸ë¬¼ì´ ì˜ìƒì— ì—†ìŠµë‹ˆë‹¤.';
        console.log('âš ï¸ Gemini ë¶„ì„ ì—ëŸ¬:', errorMessage);
        throw new Error(errorMessage);
      }

      // meta ê°ì²´ êµ¬ì„± - start_time ê³„ì‚°
      const frameNumber = analysisResult.meta?.frame_number || 0;
      const fps = analysisResult.meta?.fps_used || 30;
      const startTime = Math.round((frameNumber / fps) * 10000) / 10000; // ì†Œìˆ˜ì  4ìë¦¬, float ìœ ì§€

      const meta = {
        frame_number: frameNumber,
        total_frames: analysisResult.meta?.total_frames || 0,
        fps_used: fps,
        start_time: startTime,
        bbox: analysisResult.meta?.bbox || [{x: 0, y: 0}, {x: 0, y: 0}]
      };

      console.log('âœ… meta ì •ë³´:');
      console.log('  frame_number:', meta.frame_number);
      console.log('  total_frames:', meta.total_frames);
      console.log('  fps_used:', meta.fps_used);
      console.log('  start_time:', meta.start_time, 'ì´ˆ');
      console.log('  bbox:', meta.bbox);

      // class_typeì— class ë²ˆí˜¸ ì¶”ê°€
      const { categoryData } = require('./categories');
      const classTypeWithClassNumber = (analysisResult.class_type || []).map(item => {
        const category = categoryData[item.category];
        if (category) {
          const found = category.find(c => c.label === item.label);
          if (found) {
            return {
              category: item.category,
              class: found.class,
              label: item.label
            };
          }
        }
        // ëª» ì°¾ì€ ê²½ìš° ê¸°ë³¸ê°’
        return {
          category: item.category,
          class: item.class || 0,
          label: item.label
        };
      });

      // ìµœì¢… ê²°ê³¼ êµ¬ì„±
      const result = {
        meta: meta,
        class_type: classTypeWithClassNumber,
        subject_description: analysisResult.subject_description || []
      };

      console.log('ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì™„ë£Œ');
      console.log('ğŸ¯ ë°˜í™˜í•  result.meta:', result.meta);

      return result;

    } catch (error) {
      console.error('ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', error);
      console.error('ì›ë³¸ ì‘ë‹µ:', responseText);
      throw new Error('API ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  }
}

module.exports = {
  GeminiVideoAnalyzer
};


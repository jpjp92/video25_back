// api/lib/gemini.js

const { GoogleGenerativeAI } = require('@google/generative-ai');
const fs = require('fs').promises;

// Gemini ë¹„ë””ì˜¤ ë¶„ì„ í´ë˜ìŠ¤
class GeminiVideoAnalyzer {
  constructor(apiKey) {
    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({
      model: "gemini-2.5-flash",
      generationConfig: {
        temperature: 0,
        topP: 1,
        topK: 1,
        maxOutputTokens: 8192,
        responseMimeType: "application/json",  
      }
    });
  }

  // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
  async fileToBase64(filePath) {
    const fileBuffer = await fs.readFile(filePath);
    return fileBuffer.toString('base64');
  }

  // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ë©”íƒ€ë°ì´í„° í¬í•¨)
  static getDefaultPrompt(videoMetadata = null) {
    const { categoryData, categoryLabels } = require('./categories');

    // ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    let categoriesText = '';
    for (const [key, items] of Object.entries(categoryData)) {
      const koreanName = categoryLabels[key] || key;
      const labels = items.map(item => item.label).join(', ');
      categoriesText += `- **${key}** (${koreanName}): ${labels}\n`;
    }

    return `
ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ì£¼ì¸ê³µ 1ëª…ì„ ì‹ë³„í•˜ê³  ë‹¤ìŒ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”:

${videoMetadata ? `
## ì˜ìƒ ë©”íƒ€ë°ì´í„° (ì •í™•í•œ ì •ë³´ - ë°˜ë“œì‹œ ì‚¬ìš©)
**ì´ ì •ë³´ëŠ” ì‹¤ì œ ì˜ìƒì—ì„œ ì¶”ì¶œí•œ ì •í™•í•œ ê°’ì…ë‹ˆë‹¤. ì¶”ì¸¡í•˜ì§€ ë§ê³  ì•„ë˜ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”:**
- **ì˜ìƒ í•´ìƒë„**: ${videoMetadata.width} Ã— ${videoMetadata.height} í”½ì…€
- **FPS (ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜)**: ${videoMetadata.fps}
- **ì˜ìƒ ì „ì²´ ê¸¸ì´**: ${videoMetadata.duration}ì´ˆ
- **ì „ì²´ í”„ë ˆì„ ìˆ˜**: ${videoMetadata.totalFrames}

**ì¤‘ìš”: ìœ„ ê°’ë“¤ì€ ì ˆëŒ€ ë³€ê²½í•˜ê±°ë‚˜ ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”. JSON ì¶œë ¥ ì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.**
` : ''}

## ì‚¬ì „ ê²€ì¦ (ë§¤ìš° ì¤‘ìš”!)

**ì˜ìƒ ë¶„ì„ ê°€ëŠ¥ì„± ë¨¼ì € í™•ì¸:**
1. **ì¸ë¬¼ì´ ìˆëŠ”ê°€?** ì˜ìƒì— ì‚¬ëŒì´ ì „í˜€ ì—†ìœ¼ë©´ â†’ ì—ëŸ¬ ë°˜í™˜
2. **ì‹ë³„ ê°€ëŠ¥í•œ í¬ê¸°ì¸ê°€?** ì‚¬ëŒì´ ë„ˆë¬´ ë©€ë¦¬ ìˆê±°ë‚˜ ì‘ì•„ì„œ ì–¼êµ´/í‘œì •/ë³µì¥ì„ ì‹ë³„í•  ìˆ˜ ì—†ìœ¼ë©´ â†’ ì—ëŸ¬ ë°˜í™˜

**ì—ëŸ¬ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê²½ìš° ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:**
{
  "error": true,
  "message": "í‘œì •ì„ íƒì§€ í•  ë§Œí•œ ì¸ë¬¼ì´ ì˜ìƒì— ì—†ìŠµë‹ˆë‹¤."
}

**ìœ„ ì¡°ê±´ì„ í†µê³¼í•œ ê²½ìš°ì—ë§Œ ì•„ë˜ ë¶„ì„ ë‹¨ê³„ ì§„í–‰:**


## ë¶„ì„ ë‹¨ê³„

### 1ë‹¨ê³„: ì£¼ì¸ê³µ ì„ ì • ë° ìµœì  í”„ë ˆì„ íƒìƒ‰

** í•µì‹¬ ì›ì¹™: í•œ ëª…ì˜ ì£¼ì¸ê³µê³¼ ê·¸ ì‚¬ëŒì˜ ê°ì • ìµœëŒ€ì¹˜ í”„ë ˆì„ì„ ë™ì‹œì— ì„ ì •!**

**STEP 1: ì£¼ì¸ê³µ í›„ë³´êµ° ì‹ë³„**

ì˜ìƒ ì „ì²´ë¥¼ í›‘ì–´ë³´ë©° ë¶„ì„ ëŒ€ìƒì´ ë  ìˆ˜ ìˆëŠ” ì‚¬ëŒë“¤ì„ íŒŒì•…í•˜ì„¸ìš”:

**í›„ë³´ ì„ ì • ê¸°ì¤€:**
1. **ì–¼êµ´ í¬ê¸°**: í™”ë©´ì—ì„œ ì–¼êµ´ì´ í° ì‚¬ëŒë“¤ (1~2ëª…)
   - ì¹´ë©”ë¼ì— ê°€ê¹Œìš´ ì‚¬ëŒ ìš°ì„ 
   - ë„ˆë¬´ ë©€ë¦¬ ìˆê±°ë‚˜ ì‘ì€ ì–¼êµ´ì€ ì œì™¸

2. **ì„ ëª…ë„**: ì–¼êµ´(ëˆˆ, ì½”, ì…)ì´ ì„ ëª…í•˜ê²Œ ë³´ì´ëŠ” ì‚¬ëŒë“¤
   - íë¦¿í•˜ê±°ë‚˜ ë’¤ëŒì•„ë³¸ ì‚¬ëŒ ì œì™¸
   - ì–¼êµ´ì´ ê°€ë ¤ì§„ ì‚¬ëŒ ì œì™¸

3. **ì¶œí˜„ ë¹ˆë„**: ì˜ìƒì— ìì£¼ ë“±ì¥í•˜ëŠ” ì‚¬ëŒë“¤
   - í•œ ë‘ í”„ë ˆì„ë§Œ ë‚˜ì˜¤ëŠ” ì‚¬ëŒë³´ë‹¤ ì§€ì†ì ìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ì‚¬ëŒ ìš°ì„ 

â†’ **ê²°ê³¼: ì£¼ì¸ê³µ í›„ë³´ 1~2ëª… ì„ ì •**

**STEP 2: ê° í›„ë³´ì˜ ìµœì  í”„ë ˆì„ ì°¾ê¸°**

ê° í›„ë³´ì— ëŒ€í•´ ê°ì • í‘œí˜„ì´ ìµœëŒ€ì¹˜ì¸ í”„ë ˆì„ì„ ì°¾ìœ¼ì„¸ìš”:

**í”„ë ˆì„ ì„ ì • ê¸°ì¤€:**

1. **ê°ì • ê°•ë ¬ë„ (ê°€ì¥ ì¤‘ìš”!)**: 7ê°€ì§€ ê°ì • ì¤‘ ê°€ì¥ ê°•ë ¬í•˜ê²Œ í‘œí˜„ëœ ìˆœê°„
   - **ì¦ê±°ì›€**: ì…ì´ ìµœëŒ€í•œ í¬ê²Œ ë²Œì–´ì§€ê³  ëˆˆì´ ì´ˆìŠ¹ë‹¬ ëª¨ì–‘ì¸ ìˆœê°„, ê°€ì¥ ë°ì€ ë¯¸ì†Œ
   - **ì—´ì˜**: ê°€ì¥ ì§‘ì¤‘ë˜ê³  ì—´ì •ì ì¸ í‘œì •, ëˆˆë¹›ì´ ê°•ë ¬í•œ ìˆœê°„, ì ê·¹ì ì´ê³  í™œê¸°ì°¬ ëª¨ìŠµ
   - **í‰ì˜¨**: ê°€ì¥ í¸ì•ˆí•˜ê³  ì•ˆì •ëœ í‘œì •, ê°€ì¥ ì°¨ë¶„í•˜ê³  ì—¬ìœ ë¡œìš´ ìˆœê°„
   - **ë¶„ë…¸**: ëˆˆì¹ì´ ê°€ì¥ ì°¡ê·¸ë ¤ì§€ê³  í‘œì •ì´ êµ³ì€ ìˆœê°„, ê°€ì¥ ê²©ì–‘ë˜ê³  í™”ë‚œ í‘œì •
   - **ë¶ˆì•ˆ**: ê°€ì¥ ê¸´ì¥ë˜ê³  ì´ˆì¡°í•œ í‘œì •, ê°€ì¥ ë¶ˆì•ˆí•´ ë³´ì´ëŠ” ìˆœê°„, í”ë“¤ë¦¬ëŠ” ëˆˆë¹›
   - **ìŠ¬í””**: ëˆˆë¬¼ì´ ë³´ì´ê±°ë‚˜ ê°€ì¥ ì¹¨ìš¸í•œ ìˆœê°„, ê°€ì¥ ê¸°ìš´ ì—†ê³  ëˆˆì¹ì´ ì²˜ì§„ í‘œì •
   - **ì¤‘ë¦½**: ê°€ì¥ ë¬´í‘œì •í•œ ìƒíƒœ, íŠ¹ë³„í•œ ê°ì • í‘œí˜„ì´ ì—†ëŠ” í‰ìƒì‹œ ìƒíƒœ

2. **ì–¼êµ´ í’ˆì§ˆ**: í•´ë‹¹ í”„ë ˆì„ì—ì„œ
   - ì–¼êµ´ì´ ì„ ëª…í•˜ê²Œ ë³´ì´ëŠ”ê°€?
   - ëˆˆ, ì½”, ì…ì´ ëª¨ë‘ ëª…í™•íˆ ë³´ì´ëŠ”ê°€?
   - ì–¼êµ´ì´ í™”ë©´ì— ì¶©ë¶„íˆ í°ê°€?
   - ì •ë©´ ë˜ëŠ” ì¸¡ë©´ ê°ë„ì¸ê°€? (ë’¤ëŒì•„ë³´ì§€ ì•ŠìŒ)

**ì œì™¸í•´ì•¼ í•  í”„ë ˆì„:**
- ì–¼êµ´ì´ ê°€ë ¤ì§€ê±°ë‚˜ ì˜ë¦° ê²½ìš°
- ì›€ì§ì„ìœ¼ë¡œ íë¦¿í•œ ê²½ìš°
- ê°ì •ì´ ì• ë§¤í•˜ê±°ë‚˜ ì¤‘ê°„ ë‹¨ê³„ì¸ ê²½ìš°
- ì†ì´ë‚˜ ì‚¬ë¬¼ë§Œ ë³´ì´ëŠ” ê²½ìš°
**ê²°ê³¼: ê° í›„ë³´ë§ˆë‹¤ ìµœì  í”„ë ˆì„ 1ê°œì”© ì‹ë³„**

**STEP 3: ìµœì¢… ì£¼ì¸ê³µ 1ëª…ê³¼ í”„ë ˆì„ í™•ì •**
í›„ë³´ë“¤ì„ ë¹„êµí•˜ì—¬ ìµœì¢… ì£¼ì¸ê³µ 1ëª…ì„ ì„ íƒí•˜ì„¸ìš”:
**ìµœì¢… ì„ íƒ ê¸°ì¤€ (ìš°ì„ ìˆœìœ„):**
1. **ì¶œí˜„ ë¹ˆë„ (ê°€ì¥ ì¤‘ìš”!)**: ì˜ìƒ ì „ì²´ì—ì„œ ê°€ì¥ ë§ì´ ë“±ì¥í•˜ëŠ” í›„ë³´
   - ì˜ìƒì˜ ì£¼ì¸ê³µì€ ê°€ì¥ ìì£¼ ë“±ì¥í•˜ëŠ” ì‚¬ëŒì´ì–´ì•¼ í•¨
   - í›„ë³´ë“¤ì˜ ì´ ì¶œí˜„ í”„ë ˆì„ ìˆ˜ë¥¼ ë¹„êµ
   - í•œë‘ ë²ˆë§Œ ë‚˜ì˜¤ëŠ” ì‚¬ëŒë³´ë‹¤ ì§€ì†ì ìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ì‚¬ëŒ ìš°ì„ 

2. **ê°ì • í‘œí˜„ ê°•ë ¬ë„**: ê°ì •ì´ ê°€ì¥ ê°•ë ¬í•˜ê³  ëª…í™•í•œ í›„ë³´
   - ê°ì •ì´ "ì§„í–‰ ì¤‘"ì¸ í”„ë ˆì„ì´ ì•„ë‹Œ "ìµœëŒ€ì¹˜ì— ë„ë‹¬í•œ" í”„ë ˆì„ì¸ì§€ í™•ì¸
   - ì¦ê±°ì›€ì˜ ê²½ìš°: ì…ì´ ì™„ì „íˆ ë²Œì–´ì§€ê³  í‘œì •ì´ ê³ ì •ëœ ìˆœê°„ (ë²Œì–´ì§€ëŠ” ì¤‘ì´ ì•„ë‹˜)
   - í”„ë ˆì„ë“¤ì„ ì‹œê°„ ìˆœìœ¼ë¡œ ë¹„êµí•˜ì—¬ ê°ì •ì´ ê°€ì¥ ê°•ë ¬í•œ ìˆœê°„ ì„ íƒ
   - ë¹„ìŠ·í•œ í”„ë ˆì„ì´ ì—¬ëŸ¬ ê°œë©´ â†’ ë” ëŠ¦ì€ í”„ë ˆì„ ì„ íƒ (ê°ì •ì´ ì™„ì „íˆ ë°œë‹¬)

3. **ì–¼êµ´ í¬ê¸°**: í•´ë‹¹ í”„ë ˆì„ì—ì„œ ì–¼êµ´ì´ ë” í¬ê³  ì„ ëª…í•œ í›„ë³´

4. **ì–¼êµ´ ê°ë„**: ì •ë©´ì— ê°€ê¹Œìš´ í›„ë³´ 

â†’ **ìµœì¢… ê²°ê³¼: ì£¼ì¸ê³µ 1ëª… + ê·¸ ì‚¬ëŒì˜ ê°ì • ìµœëŒ€ì¹˜ í”„ë ˆì„ 1ê°œ í™•ì •**

** ì¤‘ìš” ê²€ì¦:**
- ì„ ì •í•œ í”„ë ˆì„ì—ì„œ ì£¼ì¸ê³µì˜ ê°ì • í‘œí˜„ì´ ì‹¤ì œë¡œ ìµœëŒ€ì¹˜ì¸ê°€?
- ì£¼ì¸ê³µ í™•ì • í›„ ë‹¤ë¥¸ ì‚¬ëŒìœ¼ë¡œ ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€!
- ì´í›„ ëª¨ë“  ë¶„ì„ì€ ì´ ì£¼ì¸ê³µê³¼ ì´ í”„ë ˆì„ì„ ê¸°ì¤€ìœ¼ë¡œ ì§„í–‰! 


#### 2ë‹¨ê³„: í”„ë ˆì„ ê¸°ë°˜ ì •ë°€ ë¶„ì„ ë° ì‹œê°„ ì •ë³´ ì¶”ì¶œ
**í•µì‹¬ ì‘ì—…:**
${videoMetadata ? `
**1. ì˜ìƒ ë©”íƒ€ë°ì´í„° (ì´ë¯¸ ì œê³µë¨ - ì¬ê³„ì‚° ë¶ˆí•„ìš”)**
   - ì˜ìƒ ì „ì²´ ê¸¸ì´: **${videoMetadata.duration}ì´ˆ** (í™•ì •ê°’)
   - FPS: **${videoMetadata.fps}** (í™•ì •ê°’)
   - ì „ì²´ í”„ë ˆì„ ìˆ˜: **${videoMetadata.totalFrames}** (í™•ì •ê°’)
   - í•´ìƒë„: **${videoMetadata.width} Ã— ${videoMetadata.height}** (í™•ì •ê°’)

**ì¤‘ìš”: ìœ„ ê°’ë“¤ì€ ì´ë¯¸ ì •í™•í•˜ê²Œ ì œê³µë˜ì—ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì¸¡ì •í•˜ê±°ë‚˜ ì¶”ì •í•˜ì§€ ë§ˆì„¸ìš”!**
` : `
1. **ì˜ìƒ ë©”íƒ€ë°ì´í„° íŒŒì•…**
   - ì˜ìƒ ì „ì²´ ê¸¸ì´(ì´ˆ) ì¸¡ì •
   - ì˜ìƒ FPS(ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜) í™•ì¸ (ì¼ë°˜ì ìœ¼ë¡œ 30fps)
   - ì „ì²´ í”„ë ˆì„ ìˆ˜ ê³„ì‚° = ì˜ìƒ ê¸¸ì´ Ã— FPS
`}

2. **ì„ ì •ëœ í”„ë ˆì„ì˜ ì‹œê°„ ê³„ì‚°**
   - 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ **ê°ì •ì´ ìµœê³ ì¡°ì¸ í”„ë ˆì„** ë²ˆí˜¸ í™•ì¸
   - **start_time ê³„ì‚° ê³µì‹: í”„ë ˆì„ ë²ˆí˜¸ Ã· FPS**
   - ì˜ˆì‹œ: í”„ë ˆì„ 75ë²ˆ, 30fps â†’ start_time = 75 Ã· 30 = 2.5ì´ˆ
   - **ì¤‘ìš”: start_timeì€ ë°˜ë“œì‹œ float í˜•ì‹ìœ¼ë¡œ í‘œê¸°** (ì˜ˆ: 2.5, 8.4, 15.0)

   ** í”„ë ˆì„ ë²ˆí˜¸ ìµœì¢… ê²€ì¦ (ë°˜ë“œì‹œ ìˆ˜í–‰!):**

   ì§ˆë¬¸ 1: **ì´ í”„ë ˆì„ì—ì„œ ì£¼ì¸ê³µì˜ ê°ì • í‘œí˜„ì´ ì‹¤ì œë¡œ ìµœëŒ€ì¹˜ì¸ê°€?**
   - ì¦ê±°ì›€: ì…ì´ ìµœëŒ€í•œ í¬ê²Œ ë²Œì–´ì§€ê³  ëˆˆì´ ì´ˆìŠ¹ë‹¬ ëª¨ì–‘ì¸ê°€?
   - ì—´ì˜: ê°€ì¥ ì§‘ì¤‘ë˜ê³  ì—´ì •ì ì¸ í‘œì •, ëˆˆë¹›ì´ ê°•ë ¬í•œê°€?
   - í‰ì˜¨: ê°€ì¥ í¸ì•ˆí•˜ê³  ì•ˆì •ëœ í‘œì •ì¸ê°€?
   - ë¶„ë…¸: ëˆˆì¹ì´ ê°€ì¥ ì°¡ê·¸ë ¤ì ¸ ìˆëŠ”ê°€?
   - ë¶ˆì•ˆ: ê°€ì¥ ê¸´ì¥ë˜ê³  ì´ˆì¡°í•œ í‘œì •ì¸ê°€?
   - ìŠ¬í””: ëˆˆë¬¼ì´ ë³´ì´ê±°ë‚˜ ê°€ì¥ ì¹¨ìš¸í•œ í‘œì •ì¸ê°€?
   - ì¤‘ë¦½: ê°€ì¥ ë¬´í‘œì •í•œ ìƒíƒœì¸ê°€?

   ì§ˆë¬¸ 2: **ì´ í”„ë ˆì„ì´ 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ì£¼ì¸ê³µì¸ê°€?**
   - ë‹¤ë¥¸ ì‚¬ëŒì´ ì•„ë‹Œ, 1ë‹¨ê³„ì—ì„œ í™•ì •í•œ ê·¸ ì‚¬ëŒì´ ë§ëŠ”ê°€?

   ì§ˆë¬¸ 3: **ì´ í”„ë ˆì„ì—ì„œ ì£¼ì¸ê³µì˜ ì–¼êµ´ì´ ëª…í™•íˆ ë³´ì´ëŠ”ê°€?**
   - ì–¼êµ´ì´ ì„ ëª…í•œê°€? íë¦¿í•˜ì§€ ì•Šì€ê°€?
   - ëˆˆ, ì½”, ì…ì´ ëª¨ë‘ ë³´ì´ëŠ”ê°€?

   **ë§Œì•½ ìœ„ ì§ˆë¬¸ ì¤‘ í•˜ë‚˜ë¼ë„ "ì•„ë‹ˆì˜¤"ë¼ë©´, ë‹¤ì‹œ 1ë‹¨ê³„ë¡œ ëŒì•„ê°€ ì˜¬ë°”ë¥¸ í”„ë ˆì„ì„ ì°¾ìœ¼ì„¸ìš”!**

3. **ì£¼ì¸ê³µ ì–¼êµ´ ë°”ìš´ë”© ë°•ìŠ¤ ì¢Œí‘œ ì¶”ì¶œ (ë§¤ìš° ì¤‘ìš”!)**

   ** í•µì‹¬: 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ê°ì • ìµœê³ ì¡° í”„ë ˆì„ì—ì„œ ê·¸ ì£¼ì¸ê³µì˜ ì–¼êµ´ë§Œ ì¸¡ì •í•©ë‹ˆë‹¤!**

   **ì¢Œí‘œê³„ ì •ì˜:**
   - í™”ë©´ **ì¢Œìƒë‹¨ ëª¨ì„œë¦¬** = (0, 0)
   - xì¶•: ì™¼ìª½(0)ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì¦ê°€
   - yì¶•: ìœ„ìª½(0)ì—ì„œ ì•„ë˜ë¡œ ì¦ê°€

   **ì¸¡ì • ëŒ€ìƒ: 1ë‹¨ê³„ì—ì„œ í™•ì •í•œ ì£¼ì¸ê³µì˜ ì–¼êµ´ë§Œ!**
   - **í¬í•¨:** ì´ë§ˆ, ëˆˆì¹, ëˆˆ, ì½”, ì…, ë³¼, í„±ì„ , ê·€, ë¨¸ë¦¬ì¹´ë½
   - **ì ˆëŒ€ í¬í•¨ ê¸ˆì§€:** ëª©, ì–´ê¹¨, ëª¸í†µ, ì˜ìƒ
   - **ì¤‘ìš”:** ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì ˆëŒ€ ì¸¡ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!

   **ë‹¨ê³„ë³„ ì¸¡ì • ì ˆì°¨ (ë§¤ìš° ì‹ ì¤‘í•˜ê²Œ!):**

   STEP 1: ì˜ìƒ í•´ìƒë„ í™•ì¸
   - ì˜ìƒì˜ ê°€ë¡œÃ—ì„¸ë¡œ í”½ì…€ í¬ê¸° íŒŒì•…${videoMetadata ? ` (**ì œê³µëœ ê°’ ì‚¬ìš©: ${videoMetadata.width}Ã—${videoMetadata.height}**)` : ' (ì˜ˆ: 1920Ã—1080, 1280Ã—720)'}

   STEP 2: **ì„ ì •í•œ ê°ì • ìµœê³ ì¡° í”„ë ˆì„ì—ì„œ 1ë‹¨ê³„ ì£¼ì¸ê³µì˜ ì–¼êµ´ ìœ„ì¹˜ ì •í™•íˆ íŒŒì•…**

   ** ì¤‘ìš”: ë¨¼ì € ì£¼ì¸ê³µ ì–¼êµ´ì´ í™”ë©´ ì–´ë””ì— ìˆëŠ”ì§€ í™•ì¸!**
   - í™”ë©´ì„ ëˆˆìœ¼ë¡œ ìŠ¤ìº”í•˜ì—¬ 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ê·¸ ì‚¬ëŒì˜ ì–¼êµ´ ì°¾ê¸°
   - ë‹¤ë¥¸ ì‚¬ëŒ, ì‚¬ë¬¼, ë¹ˆ ê³µê°„ì´ ì•„ë‹Œ **ì •í™•íˆ ê·¸ ì‚¬ëŒì˜ ì–¼êµ´** í™•ì¸

   ** ì–¼êµ´ ì°¾ê¸° ì²´í¬ë¦¬ìŠ¤íŠ¸:**
   1. í™”ë©´ì—ì„œ ì‚¬ëŒë“¤ì´ ëª‡ ëª… ë³´ì´ëŠ”ê°€?
   2. 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ì£¼ì¸ê³µì€ ì–´ëŠ ìœ„ì¹˜ì— ìˆëŠ”ê°€? (ì™¼ìª½? ì¤‘ì•™? ì˜¤ë¥¸ìª½?)
   3. ê·¸ ì‚¬ëŒì˜ ì–¼êµ´ì—ì„œ ëˆˆ, ì½”, ì…ì´ ëª…í™•íˆ ë³´ì´ëŠ”ê°€?
   4. ì–¼êµ´ì˜ ëŒ€ëµì ì¸ í™”ë©´ ìœ„ì¹˜ëŠ”? (ì˜ˆ: í™”ë©´ ì˜¤ë¥¸ìª½ 1/3 ì§€ì , ì„¸ë¡œ ì¤‘ê°„ ë¶€ê·¼)
   
   ** ì¬ì¬í™•ì¸: ì´ í”„ë ˆì„ì—ì„œ ì£¼ì¸ê³µì˜ ê°ì • í‘œí˜„ì´ ì‹¤ì œë¡œ ìµœëŒ€ì¸ê°€?**
   - ì¦ê±°ì›€: ì…ì´ ìµœëŒ€í•œ ë²Œì–´ì ¸ ìˆëŠ”ê°€? ëˆˆì´ ì´ˆìŠ¹ë‹¬ì¸ê°€?
   - ì—´ì˜: ê°€ì¥ ì§‘ì¤‘ë˜ê³  ì—´ì •ì ì¸ê°€? ëˆˆë¹›ì´ ê°•ë ¬í•œê°€?
   - í‰ì˜¨: ê°€ì¥ í¸ì•ˆí•˜ê³  ì•ˆì •ëœ í‘œì •ì¸ê°€?
   - ë¶„ë…¸: ëˆˆì¹ì´ ê°€ì¥ ì°¡ê·¸ë ¤ì ¸ ìˆëŠ”ê°€?
   - ë¶ˆì•ˆ: ê°€ì¥ ê¸´ì¥ë˜ê³  ì´ˆì¡°í•œ í‘œì •ì¸ê°€?
   - ìŠ¬í””: ê°€ì¥ ì¹¨ìš¸í•œ í‘œì •ì¸ê°€? ëˆˆë¬¼ì´ ë³´ì´ëŠ”ê°€?
   - ì¤‘ë¦½: ê°€ì¥ ë¬´í‘œì •í•œ ìƒíƒœì¸ê°€?
   - **ë§Œì•½ ê°ì •ì´ ìµœê³ ì¡°ê°€ ì•„ë‹ˆë¼ë©´, ë‹¤ì‹œ 1ë‹¨ê³„ë¡œ ëŒì•„ê°€ ì˜¬ë°”ë¥¸ í”„ë ˆì„ì„ ì°¾ìœ¼ì„¸ìš”!**
   
   STEP 3: **ì£¼ì¸ê³µ ì–¼êµ´ì˜ ì½” ì¤‘ì‹¬ì  ì •í™•íˆ ì¸¡ì •**

   ** ì¸¡ì • ì „ í•„ìˆ˜ í™•ì¸ ì ˆì°¨:**

   1. **ì£¼ì¸ê³µ ì–¼êµ´ ì˜ì—­ ë¨¼ì € íŒŒì•…:**
      - ì£¼ì¸ê³µì˜ ì–¼êµ´ì´ í™”ë©´ì˜ ì–´ëŠ ì˜ì—­ì— ìˆëŠ”ê°€?
      - ì´ë§ˆ ë§¨ ìœ„ëŠ” ëŒ€ëµ y = ?
      - í„± ëì€ ëŒ€ëµ y = ?
      - ì–¼êµ´ ì™¼ìª½ ëì€ ëŒ€ëµ x = ?
      - ì–¼êµ´ ì˜¤ë¥¸ìª½ ëì€ ëŒ€ëµ x = ?

   2. **ì–¼êµ´ ì˜ì—­ ë‚´ì—ì„œ ì½” ìœ„ì¹˜ ì°¾ê¸°:**
      - ì½”ëŠ” ì–¼êµ´ì˜ **ì„¸ë¡œ ì¤‘ê°„ ì•½ê°„ ìœ„** (ì´ë§ˆì™€ í„± ì‚¬ì´ì˜ ì¤‘ê°„)
      - ì½”ëŠ” ì–¼êµ´ì˜ **ê°€ë¡œ ì •ì¤‘ì•™** (ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ ë ì‚¬ì´ì˜ ì¤‘ì‹¬)

   3. **ì½”ì˜ ì •í™•í•œ ì¤‘ì‹¬ì  ì¸¡ì •:**
      - **ì½” ì¤‘ì‹¬ x**: ì½§ë“± ë˜ëŠ” ì½”ëì˜ ê°€ë¡œ ì¤‘ì•™ í”½ì…€ ì¢Œí‘œ
      - **ì½” ì¤‘ì‹¬ y**: ì½§ë“± ì¤‘ê°„ ë˜ëŠ” ì½”ëì˜ ì„¸ë¡œ í”½ì…€ ì¢Œí‘œ

   ** ì¸¡ì • ë°©ë²• ì˜ˆì‹œ:**
   - ì–¼êµ´ì´ í™”ë©´ ì˜¤ë¥¸ìª½ì— ìˆê³ , ì–¼êµ´ ë²”ìœ„ê°€ x: 550~750, y: 200~500 ì´ë¼ë©´
   - ì½” ì¤‘ì‹¬ x â‰ˆ (550 + 750) / 2 = 650 (ì–¼êµ´ ê°€ë¡œ ì¤‘ì•™)
   - ì½” ì¤‘ì‹¬ y â‰ˆ 200 + (500-200) Ã— 0.45 = 335 (ì–¼êµ´ ì„¸ë¡œ 45% ì§€ì )

   ** ìµœì¢… í™•ì¸:**
   - **ì´ ì¢Œí‘œê°€ 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ê·¸ ì£¼ì¸ê³µì˜ ì½” ì¤‘ì‹¬ì¸ê°€?** 
   - **ë¹ˆ ê³µê°„, ë°°ê²½, ë‹¤ë¥¸ ì‚¬ëŒì´ ì•„ë‹Œê°€?** 
   - **ì‹¤ì œ ê·¸ ì£¼ì¸ê³µì˜ ì½”ê°€ ì´ ì¢Œí‘œì— ìˆëŠ”ê°€?** 

   STEP 4: bbox ì¢Œí‘œ êµ¬ì„± ë° **ìµœì¢… ê²€ì¦**
   - **ì½” ì¤‘ì‹¬ì **: {"x": [ì½” ì¤‘ì‹¬ x], "y": [ì½” ì¤‘ì‹¬ y]}

   ** ì¶œë ¥ ì „ ë°˜ë“œì‹œ ê²€ì¦ (ë§¤ìš° ì¤‘ìš”!):**

   ë‹¤ìŒ ì§ˆë¬¸ì— ëª¨ë‘ "ì˜ˆ"ë¼ê³  ë‹µí•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸:
   1. **ì´ ì¢Œí‘œê°€ 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ê·¸ ì£¼ì¸ê³µì˜ ì½” ì¤‘ì‹¬ì„ ê°€ë¦¬í‚µë‹ˆê¹Œ?** 
   2. **ì´ ì¢Œí‘œê°€ ì‹¤ì œ ì–¼êµ´ì˜ ì½” ë¶€ë¶„ì— ìˆìŠµë‹ˆê¹Œ?** 
   3. **ë¹ˆ ê³µê°„ì´ë‚˜ ë‹¤ë¥¸ ì‚¬ë¬¼/ì‚¬ëŒì„ ê°€ë¦¬í‚¤ì§€ ì•ŠìŠµë‹ˆê¹Œ?** 
   4. **ì¢Œí‘œê°€ í™”ë©´ ë²”ìœ„ ë‚´ì…ë‹ˆê¹Œ?** (0 â‰¤ x â‰¤ ê°€ë¡œ, 0 â‰¤ y â‰¤ ì„¸ë¡œ) 
   5. **ì–¼êµ´ì˜ ë‹¤ë¥¸ ë¶€ìœ„(ëˆˆ, ì…, ê·€)ê°€ ì•„ë‹Œ ì½” ì¤‘ì‹¬ì´ ë§ìŠµë‹ˆê¹Œ?** 

   **ë§Œì•½ í•˜ë‚˜ë¼ë„ "ì•„ë‹ˆì˜¤"ë¼ë©´, ì¢Œí‘œë¥¼ ë‹¤ì‹œ ì¸¡ì •í•˜ì„¸ìš”!**

   **ì¸¡ì • ì˜ˆì‹œ:**

   í™”ë©´ ì¤‘ì•™ì— ìˆëŠ” ì£¼ì¸ê³µì˜ ì½” ìœ„ì¹˜:
   - ì½” ì¤‘ì‹¬: x=450 (í™”ë©´ ê°€ë¡œ ì¤‘ì•™ ë¶€ê·¼)
   - ì½” ì¤‘ì‹¬: y=300 (ì–¼êµ´ì˜ ì¤‘ê°„ ë†’ì´)

   ê²°ê³¼:
   "bbox": {"x": 450, "y": 300}
    
### VA(Valence-Arousal) ê°’ ë¼ë²¨ë§
ì„ ì •ëœ í”„ë ˆì„ì„ ê¸°ì¤€ìœ¼ë¡œ ê°ì •ì˜ V, A ê°’ì„ ë¼ë²¨ë§:

- **Valence(V)**: ê°ì •ì˜ ê¸ì •/ë¶€ì • ì²™ë„
* ìŠ¤ì¼€ì¼: -3 ì—ì„œ +3ê¹Œì§€ (ëª¨ë‘ ì •ìˆ˜)
* ìŒìˆ˜: ë¶€ì •ì ì¸ ê°ì •
* ì–‘ìˆ˜: ê¸ì •ì ì¸ ê°ì •
* 0: ì¤‘ë¦½

- **Arousal(A)**: ê°ì •ì˜ ê°•ë„ ì²™ë„
* ìŠ¤ì¼€ì¼: -3 ì—ì„œ +3ê¹Œì§€ (ëª¨ë‘ ì •ìˆ˜)
* ìŒìˆ˜: ì •ë„ê°€ ì•½í•œ, ì¡°ìš©í•œ ê°ì •
* ì–‘ìˆ˜: ê²©ì •ì ì´ê³  ê°•í•œ ê°ì •
* 0: ì¤‘ê°„ ê°•ë„

ì˜ˆì‹œ:
- ë¶„ë…¸í•œ ê°ì • (ê°•ë ¬): V=-3, A=+3
- ì¦ê±°ìš´ ê°ì • (ê°•ë ¬): V=+3, A=+3
- í‰ì˜¨í•œ ê°ì • : V=+2, A=-1
- ìŠ¬í”ˆ ê°ì •: V=-2, A=-2



### 3ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ (class_type)
ì•„ë˜ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì—ì„œ ì£¼ì¸ê³µì— ê°€ì¥ ì í•©í•œ labelì„ ì •í™•íˆ ì„ íƒí•˜ì„¸ìš”:
${categoriesText}

**ê°ì • ë¶„ë¥˜ ì¼ê´€ì„± ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!):**
ê¸ì • ê°ì • (EmomainCategory: "ê¸ì •"):
- class 1: ì¦ê±°ì›€ - ê¸°ì˜ê³  ìœ ì¾Œí•œ ê°ì •, ì›ƒìŒì´ë‚˜ ë¯¸ì†Œ, ë°ì€ í‘œì •
- class 2: ì—´ì˜ - ì—´ì •ì ì´ê³  ì˜ìš•ì ì¸ ê°ì •, ì ê·¹ì ì´ê³  í™œê¸°ì°¬ ëª¨ìŠµ
- class 3: í‰ì˜¨ - ì°¨ë¶„í•˜ê³  ì•ˆì •ëœ ê°ì •, í¸ì•ˆí•˜ê³  ì—¬ìœ ë¡œìš´ í‘œì •

ë¶€ì • ê°ì • (EmomainCategory: "ë¶€ì •"):
- class 4: ë¶„ë…¸ - í™”ë‚˜ê³  ì§œì¦ë‚œ ê°ì •, ì°¡ê·¸ë¦° ì–¼êµ´, ê²©ì–‘ëœ í‘œì •
- class 5: ë¶ˆì•ˆ - ê±±ì •ë˜ê³  ê¸´ì¥ëœ ê°ì •, ë¶ˆì•ˆí•˜ê³  ì´ˆì¡°í•œ ëª¨ìŠµ
- class 6: ìŠ¬í”” - ìŠ¬í”„ê³  ìš°ìš¸í•œ ê°ì •, ì¹¨ìš¸í•˜ê³  ê¸°ìš´ ì—†ëŠ” í‘œì •

ì¤‘ë¦½ ê°ì • (EmomainCategory: "ì¤‘ë¦½"):
- class 7: ì¤‘ë¦½ - íŠ¹ë³„í•œ ê°ì • í‘œí˜„ì´ ì—†ëŠ” í‰ìƒì‹œ ìƒíƒœ

**í•„ìˆ˜ ê·œì¹™:**
- EmomainCategoryê°€ "ê¸ì •"ì´ë©´ EmoCategoryëŠ” class 1~3 (ì¦ê±°ì›€, ì—´ì˜, í‰ì˜¨) ì¤‘ ì„ íƒ
- EmomainCategoryê°€ "ë¶€ì •"ì´ë©´ EmoCategoryëŠ” class 4~6 (ë¶„ë…¸, ë¶ˆì•ˆ, ìŠ¬í””) ì¤‘ ì„ íƒ
- EmomainCategoryê°€ "ì¤‘ë¦½"ì´ë©´ EmoCategoryëŠ” ë°˜ë“œì‹œ "ì¤‘ë¦½" (class 7)

**ê°ì • ë¶„ì„ ì‹œ ìƒí™© ì»¨í…ìŠ¤íŠ¸ ë°˜ë“œì‹œ ê³ ë ¤ (ë§¤ìš° ì¤‘ìš”!):**
- **ëˆˆë¬¼/ìš¸ë¨¹ì„ì´ ë³´ì—¬ë„ ìƒí™©ì— ë”°ë¼ ê¸ì •/ë¶€ì • íŒë‹¨:**
  * ê¸ì • ìƒí™© (ìˆ˜ìƒ, ì‹œìƒì‹, ê²°í˜¼ì‹, ì¬íšŒ, ê°ë™ì ì¸ ì„ ë¬¼ ë“±) + ëˆˆë¬¼/ìš¸ë¨¹ì„ = **ê¸ì •** (ê°ê²©, ì¦ê±°ì›€ ë˜ëŠ” ì—´ì˜)
  * ë¶€ì • ìƒí™© (ì´ë³„, ì‚¬ê³ , ìŠ¬í”ˆ ì†Œì‹, ì‹¸ì›€, ì‹¤íŒ¨ ë“±) + ëˆˆë¬¼/ìš¸ë¨¹ì„ = **ë¶€ì •** (ìŠ¬í””)
- **ìƒí™©ë³„ ê°ì • ë¶„ë¥˜ ì˜ˆì‹œ:**
  * ì‹œìƒì‹ì—ì„œ ìˆ˜ìƒ ì†Œê° ë§í•˜ë©° ìš¸ë¨¹ì„ â†’ EmomainCategory: "ê¸ì •", EmoCategory: "ì¦ê±°ì›€" ë˜ëŠ” "ì—´ì˜"
  * ê²°í˜¼ì‹ì—ì„œ ê°ê²©í•˜ë©° ëˆˆë¬¼ í˜ë¦¼ â†’ EmomainCategory: "ê¸ì •", EmoCategory: "ì¦ê±°ì›€"
  * ì´ë³„ ì¥ë©´ì—ì„œ ìš¸ë©° ì•ˆíƒ€ê¹Œì›Œí•¨ â†’ EmomainCategory: "ë¶€ì •", EmoCategory: "ìŠ¬í””"
  * ì‚¬ê³  ì†Œì‹ ë“£ê³  ì¶©ê²©ë°›ì•„ ìš¸ìŒ â†’ EmomainCategory: "ë¶€ì •", EmoCategory: "ìŠ¬í””"
- **ë°˜ë“œì‹œ 'ìƒí™©' ë¨¼ì € íŒŒì•… â†’ ê·¸ ë‹¤ìŒ í‘œì •/ëˆˆë¬¼ ë¶„ì„ â†’ ìµœì¢… ê°ì • ë¶„ë¥˜ ê²°ì •**

### 4ë‹¨ê³„: êµ¬ì¡°í™”ëœ ì„¤ëª…ë¬¸ ì‘ì„± (subject_description)

**ì¤‘ìš”: ëª¨ë“  ì„¤ëª…ì€ 1ë‹¨ê³„ì—ì„œ í™•ì •í•œ ê·¸ ì£¼ì¸ê³µ 1ëª…ì— ëŒ€í•´ì„œë§Œ ì‘ì„±í•©ë‹ˆë‹¤.**

ì´ 5ê°œì˜ ì„¤ëª…ë¬¸ì„ ì‘ì„±í•˜ì„¸ìš”. **ì¹´í…Œê³ ë¦¬ëª…ì€ {{}}ë¡œ ìœ ì§€**í•˜ê³ , êµ¬ì²´ì  ë‚´ìš©ì€ ì‹¤ì œ ë¶„ì„ ê²°ê³¼ë¡œ ì‘ì„±:

1. **ìƒí™© (category: "ìƒí™©")**
   - í˜•ì‹: "ë³¸ ì˜ìƒì€ [í–‰ë™/ìƒí™©]í•˜ëŠ” ì¥ë©´ì´ë‹¤."
   - ì˜ˆì‹œ:
     * "ë³¸ ì˜ìƒì€ ì¸í„°ë·° í•˜ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ ì‹ì‚¬í•˜ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ ê²°í˜¼ì‹ ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ ìš´ë™í•˜ëŠ” ì¥ë©´ì´ë‹¤."
     * "ë³¸ ì˜ìƒì€ ì—…ë¬´ í•˜ëŠ” ì¥ë©´ì´ë‹¤."
   - í…œí”Œë¦¿: "ë³¸ ì˜ìƒì€ [ì‹¤ì œ ì˜ìƒì˜ í–‰ë™/ìƒí™©]í•˜ëŠ” ì¥ë©´ì´ë‹¤."

2. **ìœ„ì¹˜ (category: "ìœ„ì¹˜")**
   - **ì¤‘ìš”: 1ë‹¨ê³„ì—ì„œ ì„ ì •í•œ ì£¼ì¸ê³µì˜ ìœ„ì¹˜ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤**
   - í˜•ì‹: "[ì„±ë³„]ëŠ” í™”ë©´ì˜ [ìœ„ì¹˜]ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - ì˜ˆì‹œ: "ì—¬ìëŠ” í™”ë©´ì˜ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤.", "ë‚¨ìëŠ” í™”ë©´ì˜ ì™¼ìª½ ìƒë‹¨ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - í…œí”Œë¦¿: "{{Male/Female}}ëŠ” í™”ë©´ì˜ [êµ¬ì²´ì  ìœ„ì¹˜]ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
   - ìœ„ì¹˜ í‘œí˜„: ì¤‘ì•™, ì™¼ìª½, ì˜¤ë¥¸ìª½, ìƒë‹¨, í•˜ë‹¨, ì¢Œìƒë‹¨, ìš°ìƒë‹¨, ì¢Œí•˜ë‹¨, ìš°í•˜ë‹¨ ë“±
   - **ê²€ì¦: bbox ì¢Œí‘œì™€ ìœ„ì¹˜ ì„¤ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ë°˜ë“œì‹œ í™•ì¸**
     * bbox x ì¢Œí‘œê°€ í™”ë©´ ì™¼ìª½ 1/3 â†’ "ì™¼ìª½"
     * bbox x ì¢Œí‘œê°€ í™”ë©´ ì¤‘ì•™ 1/3 â†’ "ì¤‘ì•™"
     * bbox x ì¢Œí‘œê°€ í™”ë©´ ì˜¤ë¥¸ìª½ 1/3 â†’ "ì˜¤ë¥¸ìª½"

3. **ì–¼êµ´ (category: "ì–¼êµ´")**
   - í˜•ì‹: "[í–‰ë™]í•˜ëŠ” [ì„±ë³„]ëŠ” [ì–¼êµ´í˜•] ì–¼êµ´, [ëˆˆ ëª¨ì–‘] ëˆˆ, [ì½” ëª¨ì–‘] ì½”, [ì… ëª¨ì–‘] ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
   - ì˜ˆì‹œ: "ê²°í˜¼í•˜ëŠ” ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´, ìˆ˜í‰í˜• ëˆˆ, ì§ì„ í˜• ì½”, ê³¡ì„ í˜• ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
   - í…œí”Œë¦¿: "[í–‰ë™]í•˜ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´, {{EyeShape}} ëˆˆ, {{NoseShape}} ì½”, {{MouthShape}} ì…ì„ ê°€ì§€ê³  ìˆë‹¤."

4. **ë³µì¥ (category: "ë³µì¥")**
   - í˜•ì‹: "[ì˜ìƒ ìœ í˜•/ìŠ¤íƒ€ì¼]ì¸ [ì£¼ìš” ìƒ‰ìƒ] [ëŒ€í‘œ ì•„ì´í…œ]ì„ ì…ê³  ìˆë‹¤." ë˜ëŠ” "[ì§ì—…/ìƒí™©ë³„ ë³µì¥ëª…]ì„ ì…ê³  ìˆë‹¤."
   - **ì‘ì„± ì›ì¹™ (ë§¤ìš° ì¤‘ìš”!):**
     * ê°€ì¥ ëˆˆì— ë„ëŠ” í•µì‹¬ íŠ¹ì§•ë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„ (ê³¼ë„í•œ ë””í…Œì¼ ì§€ì–‘)
     * **ì˜ìƒë§Œ ê¸°ìˆ , ì•…ì„¸ì‚¬ë¦¬(ê·€ê±¸ì´, ëª©ê±¸ì´, íŒ”ì°Œ, ì‹œê³„, ëª¨ì, ê°€ë°© ë“±) ì ˆëŒ€ í¬í•¨ ê¸ˆì§€**
     * **ë””ìì¸ ë””í…Œì¼(ì˜¤í”„ìˆ„ë”, ìŠ¬ë¦¼í•, Vë„¥, ë¼ìš´ë“œë„¥ ë“±) ì œì™¸**
     * ì˜ìƒ ìœ í˜• + ìƒ‰ìƒë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„
     * **ë°˜ë“œì‹œ ìƒí™© ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê³ ë ¤í•œ í›„ ë³µì¥ ë¶„ë¥˜**
     * ìƒí™©ë³„ ë³µì¥ íŒë‹¨ ì˜ˆì‹œ:
       - ë³‘ì› ìƒí™© (ì¹¨ëŒ€, ê°„í˜¸ì‚¬, ì£¼ì‚¬ ë“±) â†’ í™˜ìë³µ ë˜ëŠ” ì˜ë£Œë³µ
       - ê²°í˜¼ì‹ ìƒí™© â†’ ì›¨ë”©ë“œë ˆìŠ¤ ë˜ëŠ” ì •ì¥
       - ê²½ì°°ì„œ/ë²•ì› â†’ ì œë³µ ë˜ëŠ” ì •ì¥
       - ìš´ë™/ì²´ìœ¡ê´€ â†’ ìŠ¤í¬ì¸ ì›¨ì–´
       - ì¼ìƒ/ì§‘/ì¹´í˜ â†’ ìºì£¼ì–¼
     * **ì˜ˆì‹œ: ì¼ë°˜ í‹°ì…”ì¸ ì²˜ëŸ¼ ë³´ì—¬ë„ ìƒí™©ì´ ë³‘ì›ì´ë©´ ë°˜ë“œì‹œ "í™˜ìë³µ"ìœ¼ë¡œ ë¶„ë¥˜**

   **ì˜ìƒ ìœ í˜• ë¶„ë¥˜ ê°€ì´ë“œ:**
   | ìœ í˜• | ì„¤ëª… ë° ì˜ˆì‹œ |
   |------|-------------|
   | ìºì£¼ì–¼ | í‹°ì…”ì¸ , ì²­ë°”ì§€, í›„ë“œí‹°, ì›í”¼ìŠ¤ ë“± ì¼ìƒë³µ |
   | ë¹„ì¦ˆë‹ˆìŠ¤ | ë¸”ë¼ìš°ìŠ¤, ìŠ¬ë™ìŠ¤, ì¬í‚·, ì •ì¥ ë“± ì§ì¥/ì—…ë¬´ìš© ë‹¨ì •í•œ ë³µì¥ |
   | ì •ì¥ | ìˆ˜íŠ¸, í„±ì‹œë„, ë“œë ˆìŠ¤, ì›¨ë”©ë“œë ˆìŠ¤ ë“± ê³µì‹ í–‰ì‚¬ ê²©ì‹ ì°¨ë¦¼ ì˜ë³µ |
   | ì „í†µë³µ | í•œë³µ, ê¸°ëª¨ë…¸ ë“± ë¬¸í™”ê¶Œ íŠ¹ìœ ì˜ ì „í†µ ì˜ë³µ |
   | ê·¼ë¬´ë³µ/ìœ ë‹ˆí¼ | ì‘ì—…ë³µ, êµ°ë³µ, í•™ë³µ, ìŠ¹ë¬´ì› ìœ ë‹ˆí¼, ì˜ë£Œë³µ ë“± ì§ì¢…ì´ ëª…í™•í•œ ì˜ë³µ |
   | ìŠ¤í¬ì¸ ì›¨ì–´ | íŠ¸ë ˆì´ë‹ë³µ, ìš”ê°€ë³µ, ë“±ì‚°ë³µ, ìˆ˜ì˜ë³µ ë“± ìš´ë™/ë ˆì € í™œë™ì„ ìœ„í•œ ê¸°ëŠ¥ì„± ë³µì¥ |
   | ì•„ë”ì›¨ì–´ | ë¸Œë˜ì§€ì–´, íŒ¬í‹°, ëŸ°ë‹ì…”ì¸  ë“± ì†ì˜· |

   - **ê°„ê²°í•œ í‘œí˜„ ì˜ˆì‹œ (ê¶Œì¥):**
     * "í°ìƒ‰ ìºì£¼ì–¼ ìƒì˜ë¥¼ ì…ê³  ìˆë‹¤."
     * "ê²€ì€ìƒ‰ ì •ì¥ì„ ì…ê³  ìˆë‹¤."
     * "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."
     * "ê²½ì°° ì œë³µì„ ì…ê³  ìˆë‹¤."
     * "ê°„í˜¸ì‚¬ ìœ ë‹ˆí¼ì„ ì…ê³  ìˆë‹¤."
     * "í™˜ìë³µì„ ì…ê³  ìˆë‹¤."
     * "ì „í†µ í•œë³µì„ ì…ê³  ìˆë‹¤."
     * "íŒŒë€ìƒ‰ íŠ¸ë ˆì´ë‹ë³µì„ ì…ê³  ìˆë‹¤."

   - **ê³¼ë„í•˜ê²Œ ìƒì„¸í•œ í‘œí˜„ (ì§€ì–‘):**
     * "ìºì£¼ì–¼í•œ í°ìƒ‰ ë¯¼ì†Œë§¤ ìƒì˜ ìœ„ì— í°ìƒ‰ ì‹œìŠ¤ë£¨ ê¸´íŒ” ê°€ë””ê±´ì„ ê±¸ì¹˜ê³  ìˆë‹¤." â†’ "í°ìƒ‰ ìºì£¼ì–¼ ìƒì˜ë¥¼ ì…ê³  ìˆë‹¤."
     * "ë¹„ì¦ˆë‹ˆìŠ¤ ìŠ¤íƒ€ì¼ì˜ ë„¤ì´ë¹„ ë¸”ë£¨ ì»¬ëŸ¬ ê¸´íŒ” ë¸”ë¼ìš°ìŠ¤ì™€ íšŒìƒ‰ ìŠ¬ë¦¼í• ìŠ¬ë™ìŠ¤ë¥¼ ì°©ìš©í•˜ê³  ìˆë‹¤." â†’ "ë„¤ì´ë¹„ ë¹„ì¦ˆë‹ˆìŠ¤ ì •ì¥ì„ ì…ê³  ìˆë‹¤."
     * "ì˜¤í”„ìˆ„ë” ë””ìì¸ì˜ ë² ì´ì§€ìƒ‰ ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆìœ¼ë©°, í™”ë ¤í•œ ê·€ê±¸ì´ì™€ ëª©ê±¸ì´ë¥¼ ì°©ìš©í•˜ê³  ìˆë‹¤." â†’ "ë² ì´ì§€ìƒ‰ ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."

   - **ì¤‘ìš”**: í•µì‹¬ ì˜ìƒ ìœ í˜• + ì£¼ìš” ìƒ‰ìƒë§Œ ê°„ê²°í•˜ê²Œ í‘œí˜„
   - ë ˆì´ì–´ë§, ì¬ì§ˆ, í•, ë¸Œëœë“œ, ë””ìì¸ ë””í…Œì¼, ì•…ì„¸ì‚¬ë¦¬ ë“± ëª¨ë‘ ìƒëµ

5. **ê°ì • (category: "ê°ì •")**
   - í˜•ì‹: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
   - ì˜ˆì‹œ: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
   - í…œí”Œë¦¿: "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."

**ë§¤ìš° ì¤‘ìš”í•œ í…œí”Œë¦¿ ë³€ìˆ˜ ìœ ì§€ ê·œì¹™:**

**âŒ ì˜ëª»ëœ ì˜ˆì‹œ (ì ˆëŒ€ ì´ë ‡ê²Œ ì‘ì„±í•˜ì§€ ë§ ê²ƒ):**
- "ê²°í˜¼í•˜ëŠ” ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´" ({{Male/Female}}, {{Face}}ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¿¨ìŒ)

**âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:**
- "ê²°í˜¼í•˜ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´"

**í•„ìˆ˜ ê·œì¹™:**
1. **{{Male/Female}}, {{Face}}, {{EyeShape}}, {{NoseShape}}, {{MouthShape}}, {{EmoCategory}}, {{EmomainCategory}}** ë“± ì´ì¤‘ ì¤‘ê´„í˜¸ë¡œ ê°ì‹¸ì§„ ëª¨ë“  ë³€ìˆ˜ëŠ” **ì ˆëŒ€ë¡œ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ê¾¸ì§€ ë§ê³  ì •í™•íˆ ê·¸ëŒ€ë¡œ ìœ ì§€**í•´ì£¼ì„¸ìš”
2. ì˜ˆì‹œ: "ì—¬ìëŠ” ë‘¥ê·¼í˜• ì–¼êµ´" (âŒ ì˜ëª»ë¨) â†’ "{{Male/Female}}ëŠ” {{Face}} ì–¼êµ´" (âœ… ì˜¬ë°”ë¦„)
3. [í–‰ë™], [êµ¬ì²´ì ì¸ ìƒí™© ì„¤ëª…], [êµ¬ì²´ì  ìœ„ì¹˜] ë“± ëŒ€ê´„í˜¸ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ë§Œ ì‹¤ì œ ì˜ìƒ ë‚´ìš©ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
4. **ë³µì¥ ì„¤ëª…**: í…œí”Œë¦¿ ë³€ìˆ˜ ì—†ì´ ì˜ìƒì—ì„œ ë³´ì´ëŠ” ì˜ìƒì„ ììœ ë¡­ê²Œ ì„œìˆ 
   - ì˜ìƒ ìŠ¤íƒ€ì¼/ì¢…ë¥˜, ìƒ‰ìƒ, ë””í…Œì¼ì„ ìµœëŒ€í•œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
   - ì˜ˆ: "ìºì£¼ì–¼í•œ íšŒìƒ‰ í‹°ì…”ì¸ ë¥¼ ì…ê³  ìˆë‹¤", "í™˜ìë³µì„ ì…ê³  ìˆë‹¤", "ê²½ì°° ì œë³µì„ ì…ê³  ìˆë‹¤", "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤", "íŒŒë€ìƒ‰ í›„ë“œí‹°ë¥¼ ì…ê³  ìˆë‹¤"

**ì‘ì„± ì›ì¹™:**
- ì¹´í…Œê³ ë¦¬ëª…ì„ ì´ì¤‘ ì¤‘ê´„í˜¸ë¡œ ìœ ì§€ ({{Male/Female}}, {{Face}}, {{EmoCategory}} ë“±)
- ë³µì¥(category: "ë³µì¥")ë§Œ ì˜ˆì™¸ë¡œ í…œí”Œë¦¿ ë³€ìˆ˜ ì—†ì´ ììœ  ì„œìˆ 
- ìì—°ìŠ¤ëŸ½ê³  ë¬¸ë²•ì ìœ¼ë¡œ ì˜¬ë°”ë¥¸ í•œêµ­ì–´ ë¬¸ì¥ ì‘ì„±
- ì¡°ì‚¬(ì€/ëŠ”, ì´/ê°€, ì„/ë¥¼) ì •í™•íˆ ì‚¬ìš©


## ì¶œë ¥ í˜•ì‹
**ì¤‘ìš”:
1. ëª¨ë“  ì‹œê°„ ê°’ì€ ì •ìˆ˜ê°€ ì•„ë‹Œ ì†Œìˆ˜ì ì„ í¬í•¨í•œ float í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ (ì˜ˆ: 0ì´ ì•„ë‹Œ 0.0, 22ê°€ ì•„ë‹Œ 22.0)
2. ì•„ë˜ ì˜ˆì‹œì˜ ìˆ«ì ê°’ë“¤ì€ ì°¸ê³ ìš©ì´ë©°, ë°˜ë“œì‹œ ì‹¤ì œ ì˜ìƒ ë¶„ì„ ê²°ê³¼ë¡œ êµì²´í•´ì•¼ í•¨
${videoMetadata ? `3. **ë©”íƒ€ë°ì´í„° í•„ìˆ˜ ì‚¬ìš©**: fps_used=${videoMetadata.fps}, total_frames=${videoMetadata.totalFrames} (ì •í™•í•œ ê°’)` : ''}**

{
  "meta": {
    "frame_number": [ì£¼ì¸ê³µ íŠ¹ì§•ì´ ê°€ì¥ ëª…í™•í•œ í”„ë ˆì„ ë²ˆí˜¸],
    "total_frames": ${videoMetadata ? videoMetadata.totalFrames : '[video_duration Ã— fps_used, ë°˜ì˜¬ë¦¼]'},
    "fps_used": ${videoMetadata ? videoMetadata.fps : '[ì˜ìƒ ì‹¤ì œ í”„ë ˆì„ë ˆì´íŠ¸, ê¸°ë³¸ 30]'},
    "bbox": ["x": [ì½” ì¤‘ì‹¬ x í”½ì…€ ì¢Œí‘œ], "y": [ì½” ì¤‘ì‹¬ y í”½ì…€ ì¢Œí‘œ]]
  },
  "VA": {
     "valence": ì •ìˆ˜ê°’ (-3 ~ +3),
     "arousal": ì •ìˆ˜ê°’ (-3 ~ +3)
  },
  "class_type": [
    { "category": "Male/Female", "class": 2, "label": "ì—¬ì" },
    { "category": "EmomainCategory", "class": 2, "label": "ë¶€ì •" },
    { "category": "EmoCategory", "class": 5, "label": "ë¶ˆì•ˆ" },
    { "category": "Face", "class": 1, "label": "ë‘¥ê·¼í˜•" },
    { "category": "EyeShape", "class": 2, "label": "ìˆ˜í‰í˜•" },
    { "category": "NoseShape", "class": 1, "label": "ì§ì„ í˜•" },
    { "category": "MouthShape", "class": 2, "label": "ê³¡ì„ í˜•" }
  ],
  "subject_description": [
    {
      "category": "ìƒí™©",
      "description": "ë³¸ ì˜ìƒì€ ê²°í˜¼ì„ í•˜ëŠ” ì¥ë©´ì´ë‹¤."
    },
    {
      "category": "ìœ„ì¹˜",
      "description": "{{Male/Female}}ëŠ” í™”ë©´ì˜ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤."
    },
    {
      "category": "ì–¼êµ´",
      "description": "í–‰ë³µí•œ í‘œì •ì„ ì§“ëŠ” {{Male/Female}}ëŠ” {{Face}} ì–¼êµ´, {{EyeShape}} ëˆˆ, {{NoseShape}} ì½”, {{MouthShape}} ì…ì„ ê°€ì§€ê³  ìˆë‹¤."
    },
    {
      "category": "ë³µì¥",
      "description": "í™”ì´íŠ¸ ì›¨ë”©ë“œë ˆìŠ¤ë¥¼ ì…ê³  ìˆë‹¤."
    },
    {
      "category": "ê°ì •",
      "description": "{{Male/Female}}ëŠ” {{EmoCategory}} ìƒíƒœì˜ {{EmomainCategory}}ì  ê°ì •ì¸ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤."
    }
  ]
}
`;
  }

  // ë¹„ë””ì˜¤ ë¶„ì„ ìš”ì²­
  async analyzeVideo(filePath, mimeType) {
    try {
      console.log('ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘:', filePath);

      // 1. ë¨¼ì € ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      const { extractVideoMetadata } = require('./videoMetadata');
      const videoMetadata = extractVideoMetadata(filePath);

      // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
      const base64Data = await this.fileToBase64(filePath);

      // Gemini API ìš”ì²­ (ë©”íƒ€ë°ì´í„° í¬í•¨)
      const prompt = GeminiVideoAnalyzer.getDefaultPrompt(videoMetadata);

      console.log('ğŸ“¤ Gemini API ìš”ì²­ ì‹œì‘');
      console.log('â° ìš”ì²­ ì‹œê°„:', new Date().toLocaleTimeString());

      const requestStartTime = Date.now();
      const result = await this.model.generateContent([
        {
          inlineData: {
            data: base64Data,
            mimeType: mimeType
          }
        },
        { text: prompt }
      ]);

      const response = await result.response;
      const text = response.text();
      const requestDuration = Date.now() - requestStartTime;

      // í† í° ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© ê³„ì‚°
      const usageMetadata = response.usageMetadata;
      if (usageMetadata) {
        const inputTokens = usageMetadata.promptTokenCount || 0;
        const outputTokens = usageMetadata.candidatesTokenCount || 0;
        const totalTokens = usageMetadata.totalTokenCount || 0;

        // Gemini 2.5 Flash ê°€ê²© (per 1M tokens)
        const INPUT_PRICE_PER_1M = 0.30;  // $0.30 for text/image/video
        const OUTPUT_PRICE_PER_1M = 2.50; // $2.50 for output (including thinking tokens)

        // ë¹„ìš© ê³„ì‚° (ë‹¬ëŸ¬)
        const inputCost = (inputTokens / 1_000_000) * INPUT_PRICE_PER_1M;
        const outputCost = (outputTokens / 1_000_000) * OUTPUT_PRICE_PER_1M;
        const totalCost = inputCost + outputCost;

        console.log('ğŸ“¥ Gemini API ì‘ë‹µ ì™„ë£Œ');
        console.log('â±ï¸ ì‘ë‹µ ì‹œê°„:', (requestDuration / 1000).toFixed(2) + 'ì´ˆ');
        console.log('ğŸ” ì‘ë‹µ ê¸¸ì´:', text.length + 'ì');
        console.log('\nğŸ’° í† í° ì‚¬ìš©ëŸ‰ ë° ì˜ˆìƒ ë¹„ìš©:');
        console.log('  ğŸ“¤ Input tokens:', inputTokens.toLocaleString());
        console.log('  ğŸ“¥ Output tokens:', outputTokens.toLocaleString());
        console.log('  ğŸ“Š Total tokens:', totalTokens.toLocaleString());
        console.log('  ğŸ’µ Input cost: $' + inputCost.toFixed(6));
        console.log('  ğŸ’µ Output cost: $' + outputCost.toFixed(6));
        console.log('  ğŸ’µ Total cost: $' + totalCost.toFixed(6));
      } else {
        console.log('ğŸ“¥ Gemini API ì‘ë‹µ ì™„ë£Œ');
        console.log('â±ï¸ ì‘ë‹µ ì‹œê°„:', (requestDuration / 1000).toFixed(2) + 'ì´ˆ');
        console.log('ğŸ” ì‘ë‹µ ê¸¸ì´:', text.length + 'ì');
        console.log('âš ï¸ í† í° ì‚¬ìš©ëŸ‰ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      // JSON íŒŒì‹± (ë©”íƒ€ë°ì´í„° ì „ë‹¬)
      const analysisResult = this.parseGeminiResponse(text, videoMetadata);

      // 2. ì„ ì •ëœ í”„ë ˆì„ ì´ë¯¸ì§€ ì¶”ì¶œ
      const frameNumber = analysisResult.meta.frame_number;
      const fps = analysisResult.meta.fps_used;

      console.log('ğŸ¬ í”„ë ˆì„ ì¶”ì¶œ ì‹œì‘ (í”„ë ˆì„:', frameNumber, ')');

      const { captureFrame, deleteCapturedFrame } = require('./frameCapture');
      const framePath = await captureFrame({
        videoPath: filePath,
        frameNumber: frameNumber,
        fps: fps,
        drawOverlay: false
      });

      console.log('âœ… í”„ë ˆì„ ì¶”ì¶œ ì™„ë£Œ:', framePath);

      // 3. TensorFlowë¡œ ì •í™•í•œ ì–¼êµ´ ëœë“œë§ˆí¬ ì¶”ì¶œ
      console.log('ğŸ¤– TensorFlow ì–¼êµ´ ëœë“œë§ˆí¬ íƒì§€ ì‹œì‘');

      const { getDetector } = require('./faceLandmarks');
      const detector = getDetector();

      try {
        const nosePosition = await detector.extractNosePosition(framePath);

        console.log('âœ… TensorFlowë¡œ ì •í™•í•œ ì½” ìœ„ì¹˜ ì¶”ì¶œ ì™„ë£Œ');
        console.log('   Gemini bbox:', analysisResult.meta.bbox);
        console.log('   TensorFlow bbox:', nosePosition);

        // Geminiì˜ bboxë¥¼ TensorFlow ê²°ê³¼ë¡œ êµì²´
        analysisResult.meta.bbox = {
          x: nosePosition.x,
          y: nosePosition.y
        };

        console.log('ğŸ”„ bboxë¥¼ TensorFlow ê²°ê³¼ë¡œ êµì²´ ì™„ë£Œ');

      } catch (landmarkError) {
        console.warn('âš ï¸ ì–¼êµ´ ëœë“œë§ˆí¬ íƒì§€ ì‹¤íŒ¨, Gemini bbox ì‚¬ìš©:', landmarkError.message);
        // TensorFlow ì‹¤íŒ¨ ì‹œ Gemini bbox ê·¸ëŒ€ë¡œ ì‚¬ìš©
      } finally {
        // ì„ì‹œ í”„ë ˆì„ ì´ë¯¸ì§€ ì‚­ì œ
        await deleteCapturedFrame(framePath);
      }

      return analysisResult;

    } catch (error) {
      console.error('ë¹„ë””ì˜¤ ë¶„ì„ ì‹¤íŒ¨:', error);
      throw new Error('ë¹„ë””ì˜¤ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }

  // ì‹œê°„ ê°’ì„ ì´ˆ ë‹¨ìœ„ floatë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  parseTimeToSeconds(timeValue) {
    // ì´ë¯¸ ìˆ«ìì¸ ê²½ìš°
    if (typeof timeValue === 'number') {
      return timeValue;
    }

    // ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
    if (typeof timeValue === 'string') {
      // ì½œë¡ (:)ì´ ìˆìœ¼ë©´ ì‹œ:ë¶„:ì´ˆ í˜•ì‹
      if (timeValue.includes(':')) {
        const parts = timeValue.split(':');

        if (parts.length === 2) {
          // MM:SS.ms í˜•ì‹ (ì˜ˆ: "00:23.5" -> 23.5ì´ˆ)
          const minutes = parseInt(parts[0]) || 0;
          const seconds = parseFloat(parts[1]) || 0;
          return minutes * 60 + seconds;
        } else if (parts.length === 3) {
          // HH:MM:SS.ms í˜•ì‹
          const hours = parseInt(parts[0]) || 0;
          const minutes = parseInt(parts[1]) || 0;
          const seconds = parseFloat(parts[2]) || 0;
          return hours * 3600 + minutes * 60 + seconds;
        }
      }

      // ì ì´ 2ê°œ ì´ìƒ ìˆëŠ” ê²½ìš°: "2.02.96" í˜•ì‹ (ì˜ëª»ëœ í˜•ì‹)
      const dotCount = (timeValue.match(/\./g) || []).length;
      if (dotCount >= 2) {
        // "2.02.96" í˜•ì‹ì„ "0:122.96"ìœ¼ë¡œ í•´ì„
        const parts = timeValue.split('.');

        if (parts.length === 3) {
          // parts[0] = ë¶„, parts[1] = ì´ˆ, parts[2] = ë°€ë¦¬ì´ˆ
          const minutes = parseInt(parts[0]) || 0;
          const seconds = parseInt(parts[1]) || 0;
          const milliseconds = parseFloat('0.' + parts[2]) || 0;

          return minutes * 60 + seconds + milliseconds;
        }
      }

      // ë‹¨ìˆœ ìˆ«ì ë¬¸ìì—´ (ì˜ˆ: "22.96")
      return parseFloat(timeValue) || 0;
    }

    return 0;
  }

  // Gemini ì‘ë‹µ íŒŒì‹±
  parseGeminiResponse(responseText, videoMetadata = null) {
    try {
      // ì½”ë“œë¸”ë¡ ì œê±° (```json ... ``` í˜•ì‹)
      let cleanedText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '');

      // JSON ì¶”ì¶œ
      const startIndex = cleanedText.indexOf('{');
      const endIndex = cleanedText.lastIndexOf('}');

      if (startIndex === -1 || endIndex === -1) {
        throw new Error('JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      let jsonString = cleanedText.substring(startIndex, endIndex + 1);

      // ì–‘ìˆ˜ ì• + ê¸°í˜¸ ì œê±° (JSONì—ì„œ +2ëŠ” í—ˆìš© ì•ˆë¨, 2ë¡œ ë³€í™˜)
      jsonString = jsonString.replace(/:\s*\+(\d+)/g, ': $1');

      // ì˜ëª»ëœ ì‹œê°„ í˜•ì‹ ìˆ˜ì • (ì˜ˆ: 2.02.96 -> "00:22.96")
      // video_duration, first_appearance_time, start_time, end_timeì—ì„œ
      // ì—¬ëŸ¬ ê°œì˜ ì ì´ ìˆëŠ” ìˆ«ìë¥¼ ë¬¸ìì—´ë¡œ ê°ì‹¸ê¸°
      jsonString = jsonString.replace(/("(?:video_duration|first_appearance_time|start_time|end_time)":\s*)(\d+\.\d+\.\d+)/g, '$1"$2"');

      const analysisResult = JSON.parse(jsonString);

      // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
      if (analysisResult.error === true) {
        const errorMessage = analysisResult.message || 'ì£¼ì¸ê³µìœ¼ë¡œ ì‚¼ì„ ë§Œí•œ ì¸ë¬¼ì´ ì˜ìƒì— ì—†ìŠµë‹ˆë‹¤.';
        console.log('âš ï¸ Gemini ë¶„ì„ ì—ëŸ¬:', errorMessage);
        throw new Error(errorMessage);
      }

      // meta ê°ì²´ êµ¬ì„± - ë©”íƒ€ë°ì´í„° ì‚¬ìš© ë˜ëŠ” ê³„ì‚°
      const frameNumber = analysisResult.meta?.frame_number || 0;
      
      // videoMetadataê°€ ìˆìœ¼ë©´ ê·¸ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¶„ì„ ê²°ê³¼ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
      const fps = videoMetadata?.fps || analysisResult.meta?.fps_used || 30;
      const totalFrames = videoMetadata?.totalFrames || analysisResult.meta?.total_frames || 0;
      
      // start_time ê³„ì‚°: ì†Œìˆ˜ì  ìµœëŒ€ 4ìë¦¬ê¹Œì§€ í‘œí˜„
      let startTime = frameNumber / fps;
      
      // ì†Œìˆ˜ì  4ìë¦¬ë¡œ ë°˜ì˜¬ë¦¼
      startTime = Math.round(startTime * 10000) / 10000;
      
      // ì†Œìˆ˜ì ì´ ìˆë„ë¡ ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ ë‹¤ì‹œ íŒŒì‹± (JSON ì§ë ¬í™” ì‹œ ì†Œìˆ˜ì  ìœ ì§€)
      // ì˜ˆ: 12 -> 12.0, 11.333333 -> 11.3333
      startTime = parseFloat(startTime.toFixed(4));

      const meta = {
        frame_number: frameNumber,
        total_frames: totalFrames,
        fps_used: fps,
        start_time: startTime,
        bbox: analysisResult.meta?.bbox || {x: 0, y: 0}
      };

      // VA ê°’ ì¶”ì¶œ
      const VA = {
        valence: analysisResult.VA?.valence || 0,
        arousal: analysisResult.VA?.arousal || 0
      };

      console.log('âœ… meta ì •ë³´:');
      console.log('  frame_number:', meta.frame_number);
      console.log('  total_frames:', meta.total_frames, videoMetadata ? '(ë©”íƒ€ë°ì´í„° ì‚¬ìš©)' : '');
      console.log('  fps_used:', meta.fps_used, videoMetadata ? '(ë©”íƒ€ë°ì´í„° ì‚¬ìš©)' : '');
      console.log('  start_time:', meta.start_time, 'ì´ˆ');
      console.log('  bbox:', meta.bbox);
      console.log(' VA ì •ë³´:');
      console.log('  valence:', VA.valence);
      console.log('  arousal:', VA.arousal);

      // class_typeì— class ë²ˆí˜¸ ì¶”ê°€
      const { categoryData } = require('./categories');
      const classTypeWithClassNumber = (analysisResult.class_type || []).map(item => {
        const category = categoryData[item.category];
        if (category) {
          const found = category.find(c => c.label === item.label);
          if (found) {
            return {
              category: item.category,
              class: found.class,
              label: item.label
            };
          }
        }
        // ëª» ì°¾ì€ ê²½ìš° ê¸°ë³¸ê°’
        return {
          category: item.category,
          class: item.class || 0,
          label: item.label
        };
      });

      // ìµœì¢… ê²°ê³¼ êµ¬ì„±
      const result = {
        meta: meta,
        VA: VA,
        class_type: classTypeWithClassNumber,
        subject_description: analysisResult.subject_description || []
      };

      console.log('ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì™„ë£Œ');
      console.log('ğŸ¯ ë°˜í™˜í•  result.meta:', result.meta);
      console.log('ğŸ¯ ë°˜í™˜í•  result.VA:', result.VA);

      return result;

    } catch (error) {
      console.error('ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', error);
      console.error('ì›ë³¸ ì‘ë‹µ:', responseText);
      throw new Error('API ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
  }
}

module.exports = {
  GeminiVideoAnalyzer
};
